/*
 * Intel WebRTC SDK version 3.5.0
 * Copyright (c) 2017 Intel <http://webrtc.intel.com>
 * Homepage: http://webrtc.intel.com
 */



var Url=require("url"),spawn=require("child_process").spawn,fs=require("fs"),XMLHttpRequest=function(){var e,t,r,n=this,s=require("http"),i=require("https"),o={};"object"==typeof arguments[0]&&null!==arguments[0]&&"boolean"==typeof arguments[0].rejectUnauthorized&&(r=arguments[0].rejectUnauthorized);var a={"User-Agent":"node.js",Accept:"*/*"},c=!1,u=!1,h=a;this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null,this.open=function(e,t,r,n,s){o={method:e,url:t.toString(),async:"boolean"!=typeof r||r,user:n||null,password:s||null},this.abort(),d(this.OPENED)},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(c)throw"INVALID_STATE_ERR: send flag is true";h[e]=t},this.getResponseHeader=function(e){return this.readyState>this.OPENED&&t.headers[e]&&!u?t.headers[e]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||u)return"";var e="";for(var r in t.headers)e+=r+": "+t.headers[r]+"\r\n";return e.substr(0,e.length-2)},this.send=function(a){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(c)throw"INVALID_STATE_ERR: send has already been called";var f=!1,p=Url.parse(o.url);switch(p.protocol){case"https:":f=!0;case"http:":l=p.hostname;break;case void 0:case"":var l="localhost";break;default:throw"Protocol not supported."}var v=p.port||(f?443:80),y=p.pathname+(p.search?p.search:"");if(this.setRequestHeader("Host",l),o.user){void 0===o.password&&(o.password="");var E=new Buffer(o.user+":"+o.password);h.Authorization="Basic "+E.toString("base64")}"GET"==o.method||"HEAD"==o.method?a=null:a&&(this.setRequestHeader("Content-Length",Buffer.byteLength(a)),h["Content-Type"]||this.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));var g={host:l,port:v,path:y,method:o.method,headers:h};if(f&&void 0!==r&&(g.rejectUnauthorized=r),u=!1,!o.hasOwnProperty("async")||o.async){var S=f?i.request:s.request;c=!0,"function"==typeof n.onreadystatechange&&n.onreadystatechange(),e=S(g,function(e){(t=e).setEncoding("utf8"),d(n.HEADERS_RECEIVED),n.status=t.statusCode,t.on("data",function(e){e&&(n.responseText+=e),c&&d(n.LOADING)}),t.on("end",function(){c&&(d(n.DONE),c=!1)}),t.on("error",function(e){n.handleError(e)})}).on("error",function(e){n.handleError(e)}),a&&e.write(a),e.end()}else{var m=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(m,"","utf8");var T="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(f?"s":"")+".request;var options = "+JSON.stringify(g)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+m+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');});response.on('error', function(error) {fs.writeFileSync('"+m+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');});}).on('error', function(error) {fs.writeFileSync('"+m+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');});"+(a?"req.write('"+a.replace(/'/g,"\\'")+"');":"")+"req.end();";for(syncProc=spawn(process.argv[0],["-e",T]);""==(n.responseText=fs.readFileSync(m,"utf8")););if(syncProc.stdin.end(),fs.unlinkSync(m),n.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var _=n.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,"");n.handleError(_)}else n.status=n.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),n.responseText=n.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),d(n.DONE)}},this.handleError=function(e){this.status=503,this.statusText=e,this.responseText=e.stack,u=!0,d(this.DONE)},this.abort=function(){e&&(e.abort(),e=null),h=a,this.responseText="",this.responseXML="",u=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!c||this.readyState===this.DONE||(c=!1,d(this.DONE)),this.readyState=this.UNSENT};var f={};this.addEventListener=function(e,t){e in f||(f[e]=[]),f[e].push(t)};var d=function(e){if(n.readyState=e,"function"==typeof n.onreadystatechange&&n.onreadystatechange(),"readystatechange"in f)for(var t=f.readystatechange.length,r=0;r<t;r++)f.readystatechange[r].call(n)}},CryptoJS=CryptoJS||function(e,t){var r={},n=r.lib={},s=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var r=new e;return t&&r.mixIn(t),r.$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.$super.extend(this)}}}(),i=n.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,e=e.sigBytes;if(this.clamp(),n%4)for(var s=0;s<e;s++)t[n+s>>>2]|=(r[s>>>2]>>>24-s%4*8&255)<<24-(n+s)%4*8;else if(65535<r.length)for(s=0;s<e;s+=4)t[n+s>>>2]=r[s>>>2];else t.push.apply(t,r);return this.sigBytes+=e,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r=[],n=0;n<t;n+=4)r.push(4294967296*e.random()|0);return i.create(r,t)}}),o=r.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,e=e.sigBytes,r=[],n=0;n<e;n++){var s=t[n>>>2]>>>24-n%4*8&255;r.push((s>>>4).toString(16)),r.push((15&s).toString(16))}return r.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return i.create(r,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,e=e.sigBytes,r=[],n=0;n<e;n++)r.push(String.fromCharCode(t[n>>>2]>>>24-n%4*8&255));return r.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return i.create(r,t)}},u=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},h=n.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=i.create(),this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=u.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,n=r.words,s=r.sigBytes,o=this.blockSize,a=s/(4*o),t=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,s=e.min(4*t,s);if(t){for(var c=0;c<t;c+=o)this._doProcessBlock(n,c);c=n.splice(0,t),r.sigBytes-=s}return i.create(c,s)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=h.extend({init:function(){this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize(),this._hash},clone:function(){var e=h.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:16,_createHelper:function(e){return function(t,r){return e.create(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return f.HMAC.create(e,r).finalize(t)}}});var f=r.algo={};return r}(Math);!function(e){var t=CryptoJS,r=(n=t.lib).WordArray,n=n.Hasher,s=t.algo,i=[],o=[];!function(){function t(e){return 4294967296*(e-(0|e))|0}for(var r=2,n=0;64>n;)(function(t){for(var r=e.sqrt(t),n=2;n<=r;n++)if(!(t%n))return!1;return!0})(r)&&(8>n&&(i[n]=t(e.pow(r,.5))),o[n]=t(e.pow(r,1/3)),n++),r++}();var a=[],s=s.SHA256=n.extend({_doReset:function(){this._hash=r.create(i.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],c=r[3],u=r[4],h=r[5],f=r[6],d=r[7],p=0;64>p;p++){if(16>p)a[p]=0|e[t+p];else{var l=a[p-15],v=a[p-2];a[p]=((l<<25|l>>>7)^(l<<14|l>>>18)^l>>>3)+a[p-7]+((v<<15|v>>>17)^(v<<13|v>>>19)^v>>>10)+a[p-16]}l=d+((u<<26|u>>>6)^(u<<21|u>>>11)^(u<<7|u>>>25))+(u&h^~u&f)+o[p]+a[p],v=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&s^n&i^s&i),d=f,f=h,h=u,u=c+l|0,c=i,i=s,s=n,n=l+v|0}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+c|0,r[4]=r[4]+u|0,r[5]=r[5]+h|0,r[6]=r[6]+f|0,r[7]=r[7]+d|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;t[n>>>5]|=128<<24-n%32,t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process()}});t.SHA256=n._createHelper(s),t.HmacSHA256=n._createHmacHelper(s)}(Math),function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,r){e=this._hasher=e.create(),"string"==typeof r&&(r=t.parse(r));var n=e.blockSize,s=4*n;r.sigBytes>s&&(r=e.finalize(r));for(var i=this._oKey=r.clone(),o=this._iKey=r.clone(),a=i.words,c=o.words,u=0;u<n;u++)a[u]^=1549556828,c[u]^=909522486;i.sigBytes=o.sigBytes=s,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,e=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(e))}})}();var N=N||{};N.authors=["aalonsog@dit.upm.es","prodriguez@dit.upm.es","jcervino@dit.upm.es"],N.version=.1,(N=N||{}).Base64=function(e){"use strict";var t,r,n,s,i,o,a,c,u,h,f;for(-1,t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],r=[],i=0;i<t.length;i+=1)r[t[i]]=i;return o=function(e){n=e,s=0},a=function(){var e;return n?s>=n.length?-1:(e=255&n.charCodeAt(s),s+=1,e):-1},c=function(e){var r,n,s;for(o(e),r="",n=new Array(3),s=!1;!s&&-1!==(n[0]=a());)n[1]=a(),n[2]=a(),r+=t[n[0]>>2],-1!==n[1]?(r+=t[n[0]<<4&48|n[1]>>4],-1!==n[2]?(r+=t[n[1]<<2&60|n[2]>>6],r+=t[63&n[2]]):(r+=t[n[1]<<2&60],r+="=",s=!0)):(r+=t[n[0]<<4&48],r+="=",r+="=",s=!0);return r},u=function(){if(!n)return-1;for(;;){if(s>=n.length)return-1;var e=n.charAt(s);if(s+=1,r[e])return r[e];if("A"===e)return 0}},h=function(e){return 1===(e=e.toString(16)).length&&(e="0"+e),e="%"+e,unescape(e)},f=function(e){var t,r,n;for(o(e),t="",r=new Array(4),n=!1;!n&&-1!==(r[0]=u())&&-1!==(r[1]=u());)r[2]=u(),r[3]=u(),t+=h(r[0]<<2&255|r[1]>>4),-1!==r[2]?(t+=h(r[1]<<4&255|r[2]>>2),-1!==r[3]?t+=h(r[2]<<6&255|r[3]):n=!0):n=!0;return t},{encodeBase64:c,decodeBase64:f}}(),(N=N||{}).API=function(e){"use strict";function t(e){var t={};return e.forEach(function(e){t[e.name]={mediaMixing:e.mediaMixing}}),t}function r(e){return new Buffer(e,"utf8").toString("base64")}var n,s,i,o,a,c,u,h,f,d,p,l,v,y,E,g,S;return y={service:void 0,key:void 0,url:void 0,rejectUnauthorizedCert:void 0},S=function(t,r,n){if("string"!=typeof t||"string"!=typeof r||"string"!=typeof n)throw new TypeError("Invalid service ID, or service key, or URL.");e.API.params.service=t,e.API.params.key=r,e.API.params.url=n},n=function(e,r,n,s,i){r||(r={}),r.viewports&&(r.views=t(r.viewports),delete r.viewports),E(function(e){var t=JSON.parse(e);n(t)},s,"POST",{name:e,options:r},"rooms",i)},s=function(e,t,r){E(function(t){var r=JSON.parse(t);e(r)},t,"GET",void 0,"rooms",r)},i=function(e,t,r,n){"string"==typeof e?""!==e.trim()?E(function(e){var r=JSON.parse(e);t(r)},r,"GET",void 0,"rooms/"+e,n):r(401,"Empty room ID"):r(401,"Invalid room ID.")},o=function(e,t,r,n){E(function(e){t(e)},r,"DELETE",void 0,"rooms/"+e,n)},a=function(e,r,n,s,i){r&&r.viewports&&(r.views=t(r.viewports),delete r.viewports),E(function(e){var t=JSON.parse(e);n(t)},s,"PUT",r||{},"rooms/"+e,i)},c=function(e,t,r,n,s,i,o,a){"string"==typeof e&&"string"==typeof t&&"string"==typeof r?E(i,o,"POST",{preference:s},"rooms/"+e+"/tokens/"+n,a,t,r):"function"==typeof o&&o(400,"Invalid argument.")},u=function(e,t,r,n,s){E(function(e){var t=JSON.parse(e);r(t)},n,"POST",{name:e,key:t},"services/",s)},h=function(e,t,r){E(function(t){var r=JSON.parse(t);e(r)},t,"GET",void 0,"services/",r)},f=function(e,t,r,n){"string"==typeof e&&""!==e.trim()?E(function(e){var r=JSON.parse(e);t(r)},r,"GET",void 0,"services/"+e,n):r(400,"Invalid service ID.")},d=function(e,t,r,n){E(function(e){t(e)},r,"DELETE",void 0,"services/"+e,n)},p=function(e,t,r,n){E(function(e){var r=JSON.parse(e);t(r)},r,"GET",void 0,"rooms/"+e+"/users/",n)},l=function(e,t,r,n,s){E(function(e){var t=JSON.parse(e);r(t)},n,"GET",void 0,"rooms/"+e+"/users/"+t,s)},v=function(e,t,r,n,s){E(function(e){r(e)},n,"DELETE",void 0,"rooms/"+e+"/users/"+t,s)},E=function(t,n,s,i,o,a,c,u){var h,f,d,p,l,v,y;void 0===a||void 0===a.service&&void 0===a.key&&void 0===a.url?(h=e.API.params.service,f=e.API.params.key,o=e.API.params.url+o):(h=a.service,f=a.key,o=a.url+o),""!==h&&void 0!==h&&""!==f&&void 0!==f?(l=(d=(new Date).getTime())+","+(p=require("crypto").randomBytes(8).toString("hex")),v="MAuth realm=http://marte3.dit.upm.es,mauth_signature_method=HMAC_SHA256",c&&u&&(v+=",mauth_username=",v+=c=r(c),v+=",mauth_role=",v+=u,l+=","+c+","+u),v+=",mauth_serviceid=",v+=h,v+=",mauth_cnonce=",v+=p,v+=",mauth_timestamp=",v+=d,v+=",mauth_signature=",v+=g(l,f),(y=new XMLHttpRequest({rejectUnauthorized:e.API.params.rejectUnauthorizedCert})).onreadystatechange=function(){if(4===y.readyState)switch(y.status){case 100:case 200:case 201:case 202:case 203:case 204:case 205:"function"==typeof t&&t(y.responseText);break;default:"function"==typeof n&&n(y.status,y.responseText)}},y.open(s,o,!0),y.setRequestHeader("Authorization",v),void 0!==i?(y.setRequestHeader("Content-Type","application/json"),y.send(JSON.stringify(i))):y.send()):"function"==typeof n&&n(401,"ServiceID and Key are required!!")},g=function(t,r){var n,s;return n=CryptoJS.HmacSHA256(t,r),s=n.toString(CryptoJS.enc.Hex),e.Base64.encodeBase64(s)},{params:y,rejectUnauthorizedCert:function(t){return"boolean"==typeof t&&(e.API.params.rejectUnauthorizedCert=t),e.API.params.rejectUnauthorizedCert},init:S,createRoom:n,getRooms:s,getRoom:i,deleteRoom:o,updateRoom:a,createToken:c,createService:u,getServices:h,getService:f,deleteService:d,getUsers:p,getUser:l,deleteUser:v}}(N),module.exports=N;