/*
 * Intel WebRTC SDK version 3.5.0
 * Copyright (c) 2017 Intel <http://webrtc.intel.com>
 * Homepage: http://webrtc.intel.com
 */



!function(e){function t(e){"use strict";this.type=e.type,this.attributes=e.attributes}function n(e){"use strict";var t=this,n=new SignalingChannel;this.onConnected=null,this.onDisconnected=null,this.onConnectFailed=null,this.onChatInvitation=null,this.onChatDenied=null,this.onChatStopped=null,this.onChatAccepted=null,this.onChatSignal=null,this.onStreamType=null,this.onAuthenticated=null,n.onMessage=function(e,n){var i=JSON.parse(e);switch(i.type){case"chat-invitation":t.onChatInvitation&&t.onChatInvitation(n,i.ua);break;case"chat-accepted":t.onChatAccepted&&t.onChatAccepted(n,i.ua);break;case"chat-denied":t.onChatDenied&&t.onChatDenied(n);break;case"chat-closed":t.onChatStopped&&t.onChatStopped(n);break;case"stream-type":t.onStreamType&&t.onStreamType(i.data,n);break;case"chat-signal":t.onChatSignal&&t.onChatSignal(i.data,n);break;case"chat-negotiation-needed":t.onNegotiationNeeded&&t.onNegotiationNeeded(n);break;case"chat-negotiation-accepted":t.onNegotiationAccepted&&t.onNegotiationAccepted(n);break;default:a.Logger.error("Received unkown message")}},n.onServerDisconnected=function(){t.onDisconnected&&t.onDisconnected()},this.sendChatInvitation=function(e,t,i,a){var r={type:"chat-closed"};n.sendMessage(JSON.stringify(r),e),r={type:"chat-invitation",ua:t},n.sendMessage(JSON.stringify(r),e,i,a)},this.sendChatAccepted=function(e,t,i,a){var r={type:"chat-accepted",ua:t};n.sendMessage(JSON.stringify(r),e,i,a)},this.sendChatDenied=function(e,t,i){n.sendMessage(JSON.stringify({type:"chat-denied"}),e,t,i)},this.sendChatStopped=function(e,t,i){n.sendMessage(JSON.stringify({type:"chat-closed"}),e,t,i)},this.sendStreamType=function(e,t,i,a){var r={type:"stream-type",data:t};n.sendMessage(JSON.stringify(r),e,i,a)},this.sendSignalMessage=function(e,t,i,a){var r={type:"chat-signal",data:t};n.sendMessage(JSON.stringify(r),e,i,a)},this.sendNegotiationNeeded=function(e,t,i){n.sendMessage(JSON.stringify({type:"chat-negotiation-needed"}),e,t,i)},this.sendNegotiationAccepted=function(e,t,i){n.sendMessage(JSON.stringify({type:"chat-negotiation-accepted"}),e,t,i)},this.finalize=function(){n.disconnect()},this.connect=function(e,i,a){n.connect(e,function(e){t.onConnected&&t.onConnected(),t.onAuthenticated&&t.onAuthenticated(e),i&&i(e)},a)}}var i=function(){"use strict";var e={};return Object.defineProperties(e,{version:{get:function(){return"3.5.0"}},name:{get:function(){return"Intel WebRTC SDK"}}}),e}(),a={},r={};i.EventDispatcher=function(e){"use strict";var t={};return e.dispatcher={},e.dispatcher.eventListeners={},t.addEventListener=function(t,n){void 0===e.dispatcher.eventListeners[t]&&(e.dispatcher.eventListeners[t]=[]),e.dispatcher.eventListeners[t].push(n)},t.on=t.addEventListener,t.removeEventListener=function(t,n){if(e.dispatcher.eventListeners[t]){var i=e.dispatcher.eventListeners[t].indexOf(n);-1!==i&&e.dispatcher.eventListeners[t].splice(i,1)}},t.clearEventListener=function(t){e.dispatcher.eventListeners[t]=[]},t.dispatchEvent=function(t){e.dispatcher.eventListeners[t.type]&&e.dispatcher.eventListeners[t.type].map(function(e){e(t)})},t},i.StreamEvent=function(e){"use strict";t.call(this,e),this.stream=e.stream,this.msg=e.msg},i.ClientEvent=function(e){"use strict";t.call(this,e),this.user=e.user},i.MessageEvent=function(e){"use strict";t.call(this,e),this.msg=e.msg},i.ChatEvent=function(e){"use strict";t.call(this,e),this.type=e.type,this.senderId=e.senderId,this.peerId=e.peerId},i.DataEvent=function(e){"use strict";t.call(this,e),this.type=e.type,this.senderId=e.senderId,this.data=e.data},i.RecorderEvent=function(e){"use strict";t.call(this,e),this.recorderId=e.id},i.StreamEvent.prototype=Object.create(t.prototype),i.StreamEvent.prototype.constructor=i.StreamEvent,i.ClientEvent.prototype=Object.create(t.prototype),i.ClientEvent.prototype.constructor=i.ClientEvent,i.MessageEvent.prototype=Object.create(t.prototype),i.MessageEvent.prototype.constructor=i.MessageEvent,i.ChatEvent.prototype=Object.create(t.prototype),i.ChatEvent.prototype.constructor=i.ChatEvent,i.DataEvent.prototype=Object.create(t.prototype),i.DataEvent.prototype.constructor=i.DataEvent,i.RecorderEvent.prototype=Object.create(t.prototype),i.RecorderEvent.prototype.constructor=i.RecorderEvent,i.Common=function(){function e(e,n,i){return t(e,0,-1,n,i)}function t(e,t,n,i,a){for(var r=-1!==n?n:e.length,o=t;o<r;++o)if(0===e[o].indexOf(i)&&(!a||-1!==e[o].toLowerCase().indexOf(a.toLowerCase())))return o;return null}function n(t,n){var a=e(t,"a=rtpmap",n);return a?i(t[a]):null}function i(e){var t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+","i"),n=e.match(t);return n&&2===n.length?n[1]:null}function r(e,t){var n=e.split(" "),i=n.slice(0,3);i.push(t);for(var a=3;a<n.length;a++)n[a]!==t&&i.push(n[a]);return i.join(" ")}return{parseStats:function(e){"use strict";var t=0,n=[];return navigator.mozGetUserMedia?e.forEach(function(i,a){var r,o=!1;a.indexOf("outbound_rtp_audio_")>=0?(o=!0,r={type:"ssrc_audio_send",id:i.id,stats:{bytes_sent:i.bytesSent,codec_name:"",packets_sent:i.packetsSent,packets_lost:e.get("outbound_rtcp_audio_"+a.slice(19)).packetsLost,rtt_ms:e.get("outbound_rtcp_audio_"+a.slice(19)).mozRtt}}):a.indexOf("outbound_rtp_video_")>=0?(o=!0,r={type:"ssrc_video_send",id:i.id,stats:{bytes_sent:i.bytesSent,codec_name:"",packets_sent:i.packetsSent,packets_lost:e.get("outbound_rtcp_video_"+a.slice(19)).packetsLost,firs_rcvd:-1,plis_rcvd:-1,nacks_rcvd:-1,send_frame_width:-1,send_frame_height:-1,adapt_reason:-1,adapt_changes:-1,framerate_sent:i.framerateMean,rtt_ms:e.get("outbound_rtcp_video_"+a.slice(19)).mozRtt}}):a.indexOf("inbound_rtp_audio_")>=0?(o=!0,r={type:"ssrc_audio_recv",id:i.id,stats:{bytes_rcvd:i.bytesReceived,delay_estimated_ms:-1,packets_rcvd:i.packetsReceived,packets_lost:i.packetsLost,codec_name:""}}):a.indexOf("inbound_rtp_video_")>=0&&(o=!0,r={type:"ssrc_video_recv",id:i.id,stats:{bytes_rcvd:i.bytesReceived,packets_rcvd:i.packetsReceived,packets_lost:i.packetsLost,firs_sent:-1,nacks_sent:-1,plis_sent:-1,frame_width:-1,frame_height:-1,framerate_rcvd:i.framerateMean,framerate_output:-1,current_delay_ms:-1,codec_name:""}}),o&&(n[t]=r,t++)}):e.forEach(function(e){var i,a=!1;if("ssrc"===e.type)if(a=!0,e.bytesSent)if(e.googFrameHeightSent){var r;r=!0===e.googCpuLimitedResolution?1:!0===e.googBandwidthLimitedResolution?2:!0===e.googViewLimitedResolution?3:99,i={type:"ssrc_video_send",id:e.id,stats:{bytes_sent:e.bytesSent,codec_name:e.googCodecName,packets_sent:e.packetsSent,packets_lost:e.packetsLost,firs_rcvd:e.googFirsReceived,plis_rcvd:e.googPlisReceived,nacks_rcvd:e.googNacksReceived,send_frame_width:e.googFrameWidthSent,send_frame_height:e.googFrameHeightSent,adapt_reason:r,adapt_changes:e.googAdaptationChanges,framerate_sent:e.googFrameRateSent,rtt_ms:e.googRtt}}}else i={type:"ssrc_audio_send",id:e.id,stats:{bytes_sent:e.bytesSent,codec_name:e.googCodecName,packets_sent:e.packetsSent,packets_lost:e.packetsLost,rtt_ms:e.googRtt}};else i=e.googFrameHeightReceived?{type:"ssrc_video_recv",id:e.id,stats:{bytes_rcvd:e.bytesReceived,packets_rcvd:e.packetsReceived,packets_lost:e.packetsLost,firs_sent:e.googFirsSent,nacks_sent:e.googNacksSent,plis_sent:e.googPlisSent,frame_width:e.googFrameWidthReceived,frame_height:e.googFrameHeightReceived,framerate_rcvd:e.googFrameRateReceived,framerate_output:e.googFrameRateDecoded,current_delay_ms:e.googCurrentDelayMs,codec_name:e.googCodecName}}:{type:"ssrc_audio_recv",id:e.id,stats:{bytes_rcvd:e.bytesReceived,delay_estimated_ms:e.googCurrentDelayMs,packets_rcvd:e.packetsReceived,packets_lost:e.packetsLost,codec_name:e.googCodecName}};else"VideoBwe"===e.type&&(a=!0,i={type:"VideoBWE",id:"",stats:{available_send_bandwidth:e.googAvailableSendBandwidth,available_receive_bandwidth:e.googAvailableReceiveBandwidth,transmit_bitrate:e.googTransmitBitrate,retransmit_bitrate:e.googRetransmitBitrate}});a&&(n[t]=i,t++)}),n},parseAudioLevel:function(e){for(var t=0,n=0,i={},a=[],r=[],o=!1,s=e.result(),c=0;c<s.length;c++){var d=s[c];if("ssrc"===d.type)if(d.stat("bytesSent"))d.stat("googFrameHeightSent")||(o=!0,(u={}).ssrc=d.id,u.level=d.stat("audioInputLevel"),a[t]=u,t++);else if(d.stat("googFrameHeightReceived"));else{o=!0;var u={};u.ssrc=d.id,u.level=d.stat("audioOutputLevel"),r[n]=u,n++}}return o&&(t>0&&(i.audioInputLevels=a),n>0&&(i.audioOutputLevels=r)),i},setPreferredCodec:function(t,i,o){if(!i||!o)return a.Logger.warning("Media type or codec name is not provided."),t;var s=t.split("\r\n"),c=e(s,"m=",i);if(null===c)return t;var d=n(s,o);return d&&(s[c]=r(s[c],d)),t=s.join("\r\n")},setPreferredBitrate:function(n,i,r){var o=n.split("\r\n"),s=e(o,"m=",i);if(null===s)return a.Logger.debug("Failed to add bandwidth line to sdp, as no m-line found"),n;var c=t(o,s+1,-1,"m=");null===c&&(c=o.length);var d=t(o,s+1,c,"c=");if(null===d)return a.Logger.debug("Failed to add bandwidth line to sdp, as no c-line found"),n;var u=t(o,d+1,c,"b=AS");u&&o.splice(u,1);var l="b=AS:"+r;return o.splice(d+1,0,l),n=o.join("\r\n")},sysInfo:function(){var e=Object.create({});e.sdk={version:"3.5",type:"JavaScript"};var t=navigator.userAgent,n=/Chrome\/([0-9\.]+)/.exec(t);n?e.runtime={name:"Chrome",version:n[1]}:(n=/Firefox\/([0-9\.]+)/.exec(t))?e.runtime={name:"FireFox",version:n[1]}:(n=/Edge\/([0-9\.]+)/.exec(t))?e.runtime={name:"Edge",version:n[1]}:e.runtime={name:"Unknown",version:"Unknown"};return(n=/Windows NT ([0-9\.]+)/.exec(t))?e.os={name:"Windows NT",version:n[1]}:(n=/Intel Mac OS X ([0-9_\.]+)/.exec(t))?e.os={name:"Mac OS X",version:n[1].replace(/_/g,".")}:(n=/iPhone OS ([0-9_\.]+)/.exec(t))?e.os={name:"iPhone OS",version:n[1].replace(/_/g,".")}:(n=/X11; Linux/.exec(t))?e.os={name:"Linux",version:"Unknown"}:(n=/Android( ([0-9\.]+))?/.exec(t))?e.os={name:"Android",version:n[1]||"Unknown"}:(n=/CrOS/.exec(t))?e.os={name:"Chrome OS",version:"Unknown"}:e.os={name:"Unknown",version:"Unknown"},e}}}(),attachMediaStream=function(){a.Logger.warning("Global attachMediaStream is deprecated, pleause include woogeen.sdk.ui.js and use Woogeen.UI.attachMediaStream instead."),adapter.browserShim.attachMediaStream.apply(this,arguments)},a.Base64=function(){"use strict";var e,t,n,i,a,r,o,s,c,d,u;for(-1,e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],t=[],a=0;a<e.length;a+=1)t[e[a]]=a;return r=function(e){n=e,i=0},o=function(){var e;return n?i>=n.length?-1:(e=255&n.charCodeAt(i),i+=1,e):-1},s=function(t){var n,i,a;for(r(t),n="",i=new Array(3),a=!1;!a&&-1!==(i[0]=o());)i[1]=o(),i[2]=o(),n+=e[i[0]>>2],-1!==i[1]?(n+=e[i[0]<<4&48|i[1]>>4],-1!==i[2]?(n+=e[i[1]<<2&60|i[2]>>6],n+=e[63&i[2]]):(n+=e[i[1]<<2&60],n+="=",a=!0)):(n+=e[i[0]<<4&48],n+="=",n+="=",a=!0);return n},c=function(){if(!n)return-1;for(;;){if(i>=n.length)return-1;var e=n.charAt(i);if(i+=1,t[e])return t[e];if("A"===e)return 0}},d=function(e){return 1===(e=e.toString(16)).length&&(e="0"+e),e="%"+e,unescape(e)},u=function(e){var t,n,i;for(r(e),t="",n=new Array(4),i=!1;!i&&-1!==(n[0]=c())&&-1!==(n[1]=c());)n[2]=c(),n[3]=c(),t+=d(n[0]<<2&255|n[1]>>4),-1!==n[2]?(t+=d(n[1]<<4&255|n[2]>>2),-1!==n[3]?t+=d(n[2]<<6&255|n[3]):i=!0):i=!0;return t},{encodeBase64:s,decodeBase64:u}}(),a.Logger=function(){"use strict";var t=function(){},n={DEBUG:0,TRACE:1,INFO:2,WARNING:3,ERROR:4,NONE:5};n.log=e.console.log.bind(e.console);var i=function(t){return"function"==typeof e.console[t]?e.console[t].bind(e.console):e.console.log.bind(e.console)},a=function(e){n.debug=e<=0?i("debug"):t,n.trace=e<=1?i("trace"):t,n.info=e<=2?i("info"):t,n.warning=e<=3?i("warn"):t,n.error=e<=4?i("error"):t};return a(0),n.setLogLevel=a,n}(),function(){"use strict";function t(e){this.mediaStream=e.mediaStream,e.info=e.info||{},e.info.attributes=e.info.attributes||{},this.url=function(){if("string"==typeof e.url&&""!==e.url)return e.url},this.hasVideo=function(){return!!e.video},this.hasAudio=function(){return!!e.audio},this.attributes=function(){return e.info.attributes},this.attr=function(t,n){return arguments.length>1&&(e.info.attributes[t]=n),e.info.attributes[t]},this.id=function(){return e.id||null},this.isScreen=function(){return!!e.media&&!!e.media.video&&"screen-cast"===e.media.video.source},this.bitRate={maxVideoBW:void 0,maxAudioBW:void 0},this.toJson=function(){return{id:this.id(),audio:!!this.hasAudio()&&e.audio,video:!!this.hasVideo()&&e.video,attributes:e.attributes}}}function n(e){t.call(this,e),this.hasAudio=function(){return this.mediaStream?!!this.mediaStream.getAudioTracks().length:!!e.hasAudio},this.hasVideo=function(){return this.mediaStream?!!this.mediaStream.getVideoTracks().length:!!e.hasVideo},this.isScreen=function(){return!!e.video&&"screen"===e.video.device}}function r(e){function n(e){return"string"==typeof e&&e.startsWith("x")?Number.parseFloat(e.replace(/^x/,"")):(a.Logger.warning("Invalid bitrate multiplier input."),0)}t.call(this,e),this.isMixed=function(){return!1},this.hasAudio=function(){return!!e.media.audio},this.hasVideo=function(){return!!e.media.video},this.mediaInfo=function(){let t=JSON.parse(JSON.stringify(e.media));return t.audio&&t.audio.optional&&(t.audio.transcoding=t.audio.optional,delete t.audio.optional),t.video&&t.video.optional&&(t.video.transcoding=t.video.optional,delete t.video.optional),t.video&&t.video.transcoding&&t.video.transcoding.parameters.bitrate&&(t.video.transcoding.parameters.bitrateMultiplier=Array.from(t.video.transcoding.parameters.bitrate,e=>n(e)),t.video.transcoding.parameters.bitrateMultiplier.push(1),t.video.transcoding.parameters.bitrateMultiplier=t.video.transcoding.parameters.bitrateMultiplier.sort(),delete t.video.transcoding.parameters.bitrate),t},"forward"===e.type?this.from=e.info.owner:"mixed"===e.type&&(this.from="mcu");var i={},r=this;Object.defineProperties(this,{on:{get:function(){return function(e,t){return i[e]=i[e]||[],i[e].push(t),r}}},emit:{get:function(){return function(e){if(i[e]){var t=[].slice.call(arguments,1);i[e].map(function(e){e.apply(r,t)})}return r}}},removeListener:{get:function(){return function(e,t){return void 0===t?i[e]=[]:i[e]&&i[e].map(function(n,a){n===t&&i[e].splice(a,1)}),r}}},clearListeners:{get:function(){return function(){return i={},r}}}})}function o(e){r.call(this,e),this.resolutions=function(){let t=[];return e.media.video&&e.media.video.parameters?(e.media.video.parameters.resolution&&t.push(e.media.video.parameters.resolution),e.media.video.optional&&e.media.video.optional.parameters&&e.media.video.optional.parameters.resolution&&(t=t.concat(e.media.video.optional.parameters.resolution)),t):t},this.isMixed=function(){return!0},this.viewport=function(){return e.info.label}}function s(e){this.url=function(){if("string"==typeof e.url&&""!==e.url)return e.url},this.id=function(){return e.id||null},this.hasVideo=function(){return!!e.video},this.hasAudio=function(){return!!e.audio},this.attributes=function(){return e.attributes},this.toJson=function(){var t;return!0===e.video?t={device:"camera",source:"camera"}:!1===e.video?t=e.video:"object"==typeof e.video&&((t=e.video).device=e.video.device||"camera"),{id:this.id(),audio:e.audio,video:t,url:this.url()}}}function c(){return null!==e.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&e.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function d(){return null!==e.navigator.userAgent.match("Firefox")}function u(){return d()||null!==e.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&e.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]>=34}function l(e,t){return{width:e,height:t}}function p(e,t){if("object"!=typeof(e=JSON.parse(JSON.stringify(e)))||null===e||void 0===e.url)if(navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia){var n=arguments[3];void 0===n&&(n=2);var r={};if(null!==e&&"object"==typeof e){if(!e.audio&&!e.video)return void("function"==typeof t&&t({code:1107,msg:"At least one of audio and video must be requested."}));if(e.video){if("object"!=typeof e.video&&e.video&&(e.video=Object.create({})),"string"!=typeof e.video.device&&(e.video.device="camera"),"screen"===e.video.device&&!u()&&"function"==typeof t)return void t({code:1103,msg:"browser screen sharing not supported"});"object"==typeof e.video.resolution&&void 0!==e.video.resolution.width&&void 0!==e.video.resolution.height?r.video=JSON.parse(JSON.stringify(l(e.video.resolution.width,e.video.resolution.height))):(a.Logger.warning("Expressing an resolution in string is deprecated, please use an object like {width: 1280, height: 720} instead."),r.video=JSON.parse(JSON.stringify(m[e.video.resolution]||m.unspecified))),"string"==typeof e.video.deviceId&&(r.video.deviceId=e.video.deviceId),c()||(e.video.frameRate instanceof Array&&e.video.frameRate.length>=2?r.video.frameRate={min:e.video.frameRate[0],max:e.video.frameRate[1]}:"number"==typeof e.video.frameRate?r.video.frameRate=e.video.frameRate:a.Logger.warning("Invalid frame rate value, ignored."))}"object"==typeof e.audio?r.audio=e.audio:!0===e.audio&&(r.audio=!0)}else if("function"==typeof t)return void t({code:1107,msg:"USER_INPUT_INVALID"});var o=function(n){if("object"==typeof e.video&&"screen"===e.video.device||!(e.audio&&0===n.getAudioTracks().length||e.video&&0===n.getVideoTracks().length)){e.mediaStream=n,e.id=n.id;var a=new i.LocalStream(e);if(n.getTracks().forEach(e=>{e.onended=function(){if(n.getTracks().every(e=>"ended"===e.readyState)){const e=new i.StreamEvent({type:"Ended",stream:a});a.dispatchEvent(e)}}}),r.video)switch(r.video.width){case 320:a.bitRate.maxVideoBW=512;break;case 640:a.bitRate.maxVideoBW=1024;break;case 1280:a.bitRate.maxVideoBW=2048}"function"==typeof t&&t(null,a)}else{for(var o=0;o<n.getTracks().length;o++)n.getTracks()[o].stop();t({code:1104,msg:"Not all device requests are satisfied."})}},s=function(i){var a={code:1100,msg:i.name||i};switch(a.msg){case"Starting video failed":case"TrackStartError":if(e.video={device:e.video.device,extensionId:e.video.extensionId},n>0)return void setTimeout(function(){p(e,t,n-1)},1);a.msg="MEDIA_OPTION_INVALID",a.code=1104;break;case"DevicesNotFoundError":a.msg="DEVICES_NOT_FOUND",a.code=1102;break;case"NotSupportedError":a.msg="NOT_SUPPORTED",a.code=1105;break;case"PermissionDeniedError":a.msg="PERMISSION_DENIED",a.code=1101;break;case"PERMISSION_DENIED":a.code=1101;break;case"ConstraintNotSatisfiedError":a.msg="CONSTRAINT_NOT_SATISFIED",a.code=1106;break;default:a.msg||(a.msg="UNDEFINED")}"function"==typeof t&&t(a)};if(e.video&&"screen"===e.video.device){if(d())return void 0!==r.video?r.video.mediaSource="window":r.video={mediaSource:"window"},navigator.mediaDevices.getUserMedia(r).then(e=>{o(e)}).catch(e=>{s(e)});e.video.extensionId||a.Logger.warning("Please provide extension ID for desktop sharing.");var f=e.video.extensionId||"pndohhifhheefbpeljcmnhnkphepimhe",g=["screen","window","tab"];e.audio&&g.push("audio");try{chrome.runtime.sendMessage(f,{getStream:g},function(n){if(void 0!==n)return e.audio&&"object"!=typeof n.options&&a.Logger.warning("Desktop sharing with audio requires the latest Chrome extension. Your audio options will be ignored."),e.audio&&"object"==typeof n.options&&n.options.canRequestAudioTrack?r.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n.streamId}}:delete r.audio,r.video.mandatory=r.video.mandatory||{},r.video.mandatory.chromeMediaSource="desktop",r.video.mandatory.chromeMediaSourceId=n.streamId,r.video.height&&(r.video.mandatory.maxHeight=r.video.mandatory.minHeight=r.video.height,delete r.video.height),r.video.width&&(r.video.mandatory.maxWidth=r.video.mandatory.minWidth=r.video.width,delete r.video.width),r.video.frameRate&&("object"==typeof r.video.frameRate?(r.video.mandatory.minFrameRate=r.video.frameRate.min,r.video.mandatory.maxFrameRate=r.video.frameRate.max):"number"==typeof r.video.frameRate?(r.video.mandatory.minFrameRate=r.video.frameRate,r.video.mandatory.maxFrameRate=r.video.frameRate):a.Logger.warning("Invalid frame rate value for screen sharing."),delete r.video.frameRate),navigator.mediaDevices.getUserMedia(r).then(e=>{o(e)}).catch(e=>{s(e)});"function"==typeof t&&t({code:1103,msg:"screen sharing plugin inaccessible"})})}catch(e){"function"==typeof t&&t({code:1103,msg:"screen sharing plugin inaccessible",err:e})}}else navigator.mediaDevices.getUserMedia(r).then(e=>{o(e)}).catch(e=>{s(e)})}else"function"==typeof t&&t({code:1100,msg:"Media capturing support is not available."});else{var h="URL for LocalStream is deprecated, please use ExternalStream instead.";"function"==typeof console.warn?console.warn(h):a.Logger.warning(h);var v=new i.LocalStream(e);"function"==typeof t&&t(null,v)}}function f(e,t){if("object"==typeof e&&e.url)if(e.audio||e.video){var n=new i.ExternalStream(e);"function"==typeof t&&t(null,n)}else"function"==typeof t&&t({code:1107,msg:"External stream must have video or audio"});else"function"==typeof t&&t({code:1107,msg:"External stream must have url property"})}t.prototype=i.EventDispatcher({}),t.prototype.close=function(){this.mediaStream&&this.mediaStream.getTracks().map(function(e){"function"==typeof e.stop&&e.stop()}),null!==e.navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&this.channel&&"function"==typeof this.channel.close&&(this.channel.close(),this.channel=null)},t.prototype.createObjectURL=function(){return this.mediaStream?(e.URL||webkitURL).createObjectURL(this.mediaStream):""},t.prototype.disableAudio=function(e){var t=this;if(t.hasAudio()&&t.mediaStream){if(void 0===e&&(e=0),-1===e)return t.mediaStream.getAudioTracks().map(function(e){return!!e.enabled&&(e.enabled=!1,!0)});var n=t.mediaStream.getAudioTracks();if(n&&n[e]&&n[e].enabled)return n[e].enabled=!1,!0}return!1},t.prototype.enableAudio=function(e){var t=this;if(t.hasAudio()&&t.mediaStream){if(void 0===e&&(e=0),-1===e)return t.mediaStream.getAudioTracks().map(function(e){return!0!==e.enabled&&(e.enabled=!0,!0)});var n=t.mediaStream.getAudioTracks();if(n&&n[e]&&!0!==n[e].enabled)return n[e].enabled=!0,!0}return!1},t.prototype.disableVideo=function(e){var t=this;if(t.hasVideo()&&t.mediaStream){if(void 0===e&&(e=0),-1===e)return t.mediaStream.getVideoTracks().map(function(e){return!!e.enabled&&(e.enabled=!1,!0)});var n=t.mediaStream.getVideoTracks();if(n&&n[e]&&n[e].enabled)return n[e].enabled=!1,!0}return!1},t.prototype.enableVideo=function(e){var t=this;if(t.hasVideo()&&t.mediaStream){if(void 0===e&&(e=0),-1===e)return t.mediaStream.getVideoTracks().map(function(e){return!0!==e.enabled&&(e.enabled=!0,!0)});var n=t.mediaStream.getVideoTracks();if(n&&n[e]&&!0!==n[e].enabled)return n[e].enabled=!0,!0}return!1},t.prototype.updateConfiguration=function(e,t){if(void 0!==e)return this.channel?void this.channel.updateSpec(e,t):"This stream has not been published, ignoring"},n.prototype=Object.create(t.prototype),r.prototype=Object.create(t.prototype),o.prototype=Object.create(r.prototype),s.prototype=i.EventDispatcher({}),n.prototype.constructor=n,r.prototype.constructor=r,o.prototype.constructor=o,s.prototype.constructor=s;var m={true:{},unspecified:{},sif:l(320,240),vga:l(640,480),hd720p:l(1280,720),hd1080p:l(1920,1080)};n.create=function(){p.apply(this,arguments)},s.create=function(){f.apply(this,arguments)},i.Stream=t,i.LocalStream=n,i.RemoteStream=r,i.RemoteMixedStream=o,i.ExternalStream=s}(),function(){"use strict";function e(){this.socket=null}function t(e,t,i){return new Promise((a,r)=>{e.emit(t,i,(e,t)=>{n(e,t,a,r)})})}const n=function(e,t,n,i){"ok"===e||"success"===e?n(t):"error"===e?i(t):a.Logger.error("MCU returns unknown ack.")};e.prototype.constructor=e,e.prototype=i.EventDispatcher({}),e.create=function(t){return new e(t)},e.prototype.connect=function(e,t,a){const r=this;return new Promise((o,s)=>{r.socket=io.connect(e,{reconnect:!1,secure:t,"force new connection":!0}),["drop","participant","text","stream","progress"].forEach(e=>{r.socket.on(e,t=>{const n=new i.MessageEvent({type:e,msg:t});r.dispatchEvent(n)})}),r.socket.on("disconnect",()=>{r.dispatchEvent({type:"disconnect"})}),r.socket.emit("login",a,(e,t)=>{n(e,t,o,s)})})},e.prototype.disconnect=function(){const e=this;return new Promise((t,i)=>{e.socket.emit("logout",(a,r)=>{e.socket.disconnect(),n(a,r,t,i)})})},e.prototype.sendMessage=function(e,n){return t(this.socket,e,n)},i.ConferenceSioSignaling=e}(),function(){function t(){var e=arguments[0];if("function"==typeof e){var t=Array.prototype.slice.call(arguments,1);e.apply(null,t)}}function n(e){e.session_id=i.sessionId+=1;var t={};if(t.browser=l(),"mozilla"===t.browser)a.Logger.debug("Firefox Stack"),t=r.FirefoxStack(e);else if("bowser"===t.browser)a.Logger.debug("Bowser Stack"),t=r.BowserStack(e);else if("chrome-stable"===t.browser)a.Logger.debug("Stable!"),t=r.ChromeStableStack(e);else{if("edge"!==t.browser)throw a.Logger.debug("None!"),"WebRTC stack not available";a.Logger.debug("Edge Stack"),t=r.EdgeORTCStack(e)}return t.updateSpec||(t.updateSpec=function(e,t){a.Logger.error("Update Configuration not implemented in this browser"),t&&t("unimplemented")}),t}function o(e){return"mixed"===e.type?new i.RemoteMixedStream(e):new i.RemoteStream(e)}function s(e,t,n,i){if(!e||!e.connected)return i("socket not ready");try{e.emit(t,n,function(e,t){return"success"===e?i(null,t):i(t||"response error")})}catch(e){i("socket emit error")}}function c(e,n,a,r,o,s){if(!(a instanceof i.Stream||a instanceof i.ExternalStream))return t(s,"Invalid stream");if(!Array.isArray(r))return t(s,"Target streams is not a list");var c,d,u=[];for(c=0;c<r.length;c++){if(!((d=r[c])instanceof i.RemoteMixedStream))return t(s,"Invalid stream found in targetStreams.");u.push(n.sendMessage("stream-control",{id:a.id(),operation:e,data:d.viewport()}))}Promise.all(u).then(()=>t(o,null),e=>t(s,e))}function d(e,n,a,r,o,s){if(a instanceof i.Stream)if(void 0===r||"audio"===r||"video"===r){var c=r||"av";n.sendMessage("stream-control",{id:a.id(),operation:e,data:c}).then(()=>{t(o)},e=>{t(s,e)})}else t(s,"Invalid track kind.");else t(s,"Invalid stream")}function u(e,n,i,a,r,o){if(void 0===a||"audio"===a||"video"===a){var s=a||"av";n.sendMessage("subscription-control",{id:i,operation:e,data:s}).then(()=>{t(r)},e=>{t(o,e)})}else t(o,"Invalid track kind.")}var l=function(){var t="none";return null!==e.navigator.userAgent.match("Firefox")?t="mozilla":null!==e.navigator.userAgent.match("Bowser")?t="bowser":null!==e.navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?t="edge":null!==e.navigator.userAgent.match("Chrome")?e.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]>=26&&(t="chrome-stable"):null!==e.navigator.userAgent.match("Safari")?t="chrome-stable":null!==e.navigator.userAgent.match("WebKit")&&(t="chrome-stable"),t};const p={cif:{width:352,height:288},vga:{width:640,height:480},svga:{width:800,height:600},xga:{width:1024,height:768},r640x360:{width:640,height:360},hd720p:{width:1280,height:720},sif:{width:320,height:240},hvga:{width:480,height:320},r480x360:{width:480,height:360},qcif:{width:176,height:144},r192x144:{width:192,height:144},hd1080p:{width:1920,height:1080},uhd_4k:{width:3840,height:2160},r360x360:{width:360,height:360},r480x480:{width:480,height:480},r720x720:{width:720,height:720}};var f=function(e){e=e||{},this.internalDispatcher=i.EventDispatcher({}),this.spec={},this.remoteStreams={},this.localStreams=new Map,this.subscriptionToStream=new Map,this.streamIdToSubscriptionId=new Map,this.state=0,this.commonMixedStream=null,this.participants=[],this.externalUrlToSubscriptionId=new Map,this.recorderCallbacks={},this.publicationCallbacks={},this.subscriptionCallbacks={},this.externalOutputCallbacks=new Map,this.unmixStreams=new Set,e.iceServers&&(this.spec.userSetIceServers=e.iceServers)};(f.prototype=i.EventDispatcher({})).getIceServers=function(){return this.spec.userSetIceServers},f.prototype.join=function(e,n,r){var s;try{s=JSON.parse(a.Base64.decodeBase64(e))}catch(e){return t(r,"invalid token")}var c=this,d=!0===s.secure,u=s.host;if("string"!=typeof u)return t(r,"invalid host");if(-1===u.indexOf("http")&&(u=d?"https://"+u:"http://"+u),0!==c.state)return t(r,"connection state invalid");c.state=1;const l={token:e,userAgent:i.Common.sysInfo(),protocol:"1.0"};c.signaling=i.ConferenceSioSignaling.create(),c.signaling.connect(u,d,l).then(e=>{c.state=2,c.myId=e.user,c.participantId=e.id;let r=e.room,s=[];void 0!==r.streams&&(s=r.streams.map(function(e){return"mixed"===e.type&&(e.viewport=e.info.label),c.remoteStreams[e.id]=o(e),"common"===e.viewport&&(c.commonMixedStream=c.remoteStreams[e.id]),c.remoteStreams[e.id]}));var d;if(e.room&&void 0!==e.room.participants)for(var u=0;u<e.room.participants.length;u++)if(e.room.participants[u].id===e.id){d=e.room.participants[u];break}return c.signaling.on("stream",function(e){let t,n;switch((e=e.msg).status){case"add":const r=e.data;if(void 0!==c.remoteStreams[r.id])return void a.Logger.warning("Stream was already added:",r.id);t=o(r),n=new i.StreamEvent({type:"stream-added",stream:t}),c.remoteStreams[r.id]=t,c.dispatchEvent(n);break;case"remove":(t=c.remoteStreams[e.id])&&(t.close(),delete c.remoteStreams[e.id],n=new i.StreamEvent({type:"stream-removed",stream:t}),c.dispatchEvent(n));break;case"update":if(!(t=c.remoteStreams[e.id]))return void a.Logger.warning("Invalid stream ID.");switch(e.data.field){case"video.layout":t.emit("VideoLayoutChanged",e.data.value);break;case"audio.status":"active"===e.data.value?t.emit("AudioEnabled"):"inactive"===e.data.value?t.emit("AudioDisabled"):a.Logger.warning("Invalid stream event.");break;case"video.status":"active"===e.data.value?t.emit("VideoEnabled"):"inactive"===e.data.value?t.emit("VideoDisabled"):a.Logger.warning("Invalid stream event.");break;default:a.Logger.warning("Unknown message from MCU.")}break;default:a.Logger.warning("Received unknown stream notification.")}}),c.signaling.on("progress",function(e){e=e.msg;let n=c.subscriptionToStream.get(e.id);if(n||(n=c.localStreams.get(e.id)),n||c.recorderCallbacks[e.id]||c.externalOutputCallbacks.has(e.id)){if("soac"===e.status&&n&&n.channel)n.channel.processSignalingMessage(e.data);else if("ready"===e.status)c.recorderCallbacks[e.id]?(t(c.recorderCallbacks[e.id].onSuccess,{recorderId:e.id,host:e.data.host,path:e.data.file}),delete c.recorderCallbacks[e.id]):c.publicationCallbacks[e.id]?((n instanceof i.ExternalStream||!n.isScreen())&&c.commonMixedStream&&!c.unmixStreams.has(e.id)&&c.mix(n,[c.commonMixedStream]),c.unmixStreams.delete(e.id),t(c.publicationCallbacks[e.id].onSuccess,n),delete c.publicationCallbacks[e.id]):c.subscriptionCallbacks[e.id]?(t(c.subscriptionCallbacks[e.id].onSuccess,n),delete c.subscriptionCallbacks[e.id]):c.externalOutputCallbacks.has(e.id)&&(t(c.externalOutputCallbacks.get(e.id).onSuccess),c.externalOutputCallbacks.delete(e.id));else if("error"===e.status)if(c.recorderCallbacks[e.id]?(t(c.recorderCallbacks[e.id].onFailure,e.data),delete c.recorderCallbacks[e.id]):c.publicationCallbacks[e.id]?(t(c.publicationCallbacks[e.id].onFailure,e.data),delete c.publicationCallbacks[e.id]):c.subscriptionCallbacks[e.id]?(t(c.subscriptionCallbacks[e.id].onFailure,e.data),delete c.subscriptionCallbacks[e.id]):c.externalOutputCallbacks.has(e.id)&&(t(c.externalOutputCallbacks.get(e.id).onFailure),c.externalOutputCallbacks.delete(e.id)),c.localStreams.has(e.id)){const t=new i.StreamEvent({type:"stream-failed",stream:c.localStreams.get(e.id),msg:e.data});c.dispatchEvent(t)}else if(c.subscriptionToStream.has(e.id)){const t=new i.StreamEvent({type:"stream-failed",stream:c.subscriptionToStream.get(e.id),msg:e.data});c.dispatchEvent(t)}}else a.Logger.warning("Cannot find associated stream.")}),c.signaling.on("text",function(e){const t=JSON.parse(JSON.stringify(e.msg));t.data=t.message,delete t.message;var n=new i.MessageEvent({type:"message-received",msg:t});c.dispatchEvent(n)}),c.signaling.on("participant",e=>{let t,n;switch((e=e.msg).action){case"join":t={id:e.data.id,role:e.data.role,name:e.data.user},c.participants[t.id]=t,n=new i.ClientEvent({type:"user-joined",user:t}),c.dispatchEvent(n);break;case"leave":if(!(t=c.participants[e.data]))return;n=new i.ClientEvent({type:"user-left",user:t}),delete c.participants[e.data],c.dispatchEvent(n);break;default:a.Logger.warning("Received unknown message.")}}),c.signaling.on("disconnect",()=>{c.state=0,c.subscriptionToStream.forEach(e=>{c.unsubscribe(e)}),c.localStreams.forEach(e=>{c.unpublish(e)}),c.signaling.clearEventListener("stream"),c.signaling.clearEventListener("progress"),c.signaling.clearEventListener("participants"),c.signaling.clearEventListener("disconnect");const e=new i.ClientEvent({type:"server-disconnected"});c.dispatchEvent(e)}),t(n,{streams:s,users:e.room.participants,self:d})},e=>(c.state=0,t(r,e||"response error")))},f.prototype.publish=function(e,r,o,s){var c=this;if(e=e||{},"function"==typeof r?(s=o,o=r):"object"==typeof r&&null!==r||(r={}),!(e instanceof i.LocalStream||e instanceof i.ExternalStream)||("object"!=typeof e.mediaStream||null===e.mediaStream)&&void 0===e.url())return t(s,"invalid stream");if(r.videoCodec=r.videoCodec||"h264",c.localStreams.has(e.id()))return t(s,"already published");{var u=e.toJson();if(!0===r.unmix&&(u.unmix=!0),void 0!==e.url()){let n={};n.url=e.url(),n.transportProtocol=r.transport,n.bufferSize=r.bufferSize;let a={audio:"auto",video:"auto"};return e instanceof i.ExternalStream&&(a.audio=e.hasAudio(),a.video=e.hasVideo()),void c.signaling.sendMessage("publish",{type:"streaming",connection:n,media:a,attributes:e.attributes()}).then(t=>{const n=t.id;e.id=function(){return n},r.unmix&&c.unmixStreams.add(n),c.localStreams.set(n,e),c.publicationCallbacks[n]={onSuccess:o,onFailure:s}},e=>{t(s,e)})}let l={};if(e.hasAudio()?(l.audio={},"object"==typeof u.audio?l.audio.source=u.audio.source:l.audio.source="mic"):l.audio=!1,e.hasVideo()){if(e.mediaStream.getVideoTracks().length<1)return void t(s,"Invalid video track.");l.video={},e.isScreen()?l.video.source="screen-cast":l.video.source="camera";const n=e.mediaStream.getVideoTracks()[0].getSettings();l.video.parameters={resolution:{width:n.width,height:n.height},framerate:n.frameRate}}else l.video=!1;c.signaling.sendMessage("publish",{type:"webrtc",connection:void 0,media:l,attributes:e.attributes()}).then(t=>{const i=t.id;e.id=function(){return i},r.unmix&&c.unmixStreams.add(i),c.publicationCallbacks[i]={onSuccess:o,onFailure:s},c.localStreams.set(i,e),e.channel=n({callback:function(e){console.log("Sending message",e),c.signaling.sendMessage("soac",{id:i,signaling:e})},video:e.hasVideo(),audio:e.hasAudio(),iceServers:c.getIceServers(),maxAudioBW:r.maxAudioBW,maxVideoBW:r.maxVideoBW,audioCodec:r.audioCodec,videoCodec:r.videoCodec});var u=function(){e.signalOnPlayAudio=function(t,n){d("play",c.signaling,e,"audio",t,n)},e.signalOnPauseAudio=function(t,n){d("pause",c.signaling,e,"audio",t,n)},e.signalOnPlayVideo=function(t,n){d("play",c.signaling,e,"video",t,n)},e.signalOnPauseVideo=function(t,n){d("pause",c.signaling,e,"video",t,n)}},l=function(){e.channel.close(),e.channel=void 0};e.channel.oniceconnectionstatechange=function(e){switch(e){case"completed":case"connected":u();break;case"checking":case"closed":break;case"failed":l();break;default:a.Logger.warning("unknown ice connection state:",e)}},e.channel.addStream(e.mediaStream),e.channel.createOffer(!1)},e=>{t(s,e)})}},f.prototype.unpublish=function(e,n,a){var r=this;e instanceof i.LocalStream||e instanceof i.ExternalStream?r.localStreams.has(e.id())?(e.channel&&"function"==typeof e.channel.close&&(e.channel.close(),e.channel=null),r.localStreams.delete(e.id()),e.signalOnPlayAudio=void 0,e.signalOnPauseAudio=void 0,e.signalOnPlayVideo=void 0,e.signalOnPauseVideo=void 0,r.signaling.sendMessage("unpublish",{id:e.id()}),e.id=function(){return null},t(n)):t(a,"The specific stream is not published."):t(a,"invalid stream")},f.prototype.subscribe=function(e,r,o,s){var c=this;if("function"==typeof r?(s=o,o=r,r={}):"object"==typeof r&&null!==r||(r={}),!(e instanceof i.RemoteStream))return t(s,"invalid stream");if(c.streamIdToSubscriptionId.has(e.id()))return t(s,"Already subscribed.");if(!1===r.audio&&!1===r.video)return t(s,"no audio or video to subscribe.");r.videoCodec=r.videoCodec||"h264";let d=!(!e.hasAudio()||!1===r.audio)&&{from:e.id()},l=!(!e.hasVideo()||!1===r.video)&&{from:e.id()};if(r.video&&r.video.resolution&&(l.parameters={},l.parameters.resolution=r.video.resolution),"object"==typeof r.video){if(r.video.qualityLevel)switch(l.parameters=l.parameters||{},r.video.qualityLevel){case"BestQuality":l.parameters.bitrate="x1.4";break;case"BetterQuality":l.parameters.bitrate="x1.2";break;case"Standard":l.parameters.bitrate="x1.0";break;case"BetterSpeed":l.parameters.bitrate="x0.8";break;case"BestSpeed":l.parameters.bitrate="x0.6";break;default:a.Logger.warning("Invalid quality level.")}r.video.frameRate&&(l.parameters=l.parameters||{},l.parameters.framerate=r.video.frameRate),r.video.keyFrameInterval&&(l.parameters=l.parameters||{},l.parameters.keyFrameInterval=r.video.keyFrameInterval),r.video.bitrateMultiplier&&1!==r.video.bitrateMultiplier&&(l.parameters=l.parameters||{},l.parameters.bitrate="x"+r.video.bitrateMultiplier.toString())}c.signaling.sendMessage("subscribe",{type:"webrtc",connection:void 0,media:{audio:d,video:l}}).then(t=>{c.subscriptionToStream.set(t.id,e),c.streamIdToSubscriptionId.set(e.id(),t.id),c.subscriptionCallbacks[t.id]={onSuccess:o,onFailure:s},e.channel=n({callback:function(e){c.signaling.sendMessage("soac",{id:t.id,signaling:e})},audio:e.hasAudio()&&!1!==r.audio,video:e.hasVideo()&&!1!==r.video,iceServers:c.getIceServers(),videoCodec:r.videoCodec}),e.channel.onaddstream=function(n){e.mediaStream=n.stream,a.Logger.info("Subscription "+t.id+"'s MediaStream is ready.")};var i=function(){e.signalOnPlayAudio=function(e,n){u("play",c.signaling,t.id,"audio",e,n)},e.signalOnPauseAudio=function(e,n){u("pause",c.signaling,t.id,"audio",e,n)},e.signalOnPlayVideo=function(e,n){u("play",c.signaling,t.id,"video",e,n)},e.signalOnPauseVideo=function(e,n){u("pause",c.signaling,t.id,"video",e,n)}},d=function(){e.channel&&e.channel.close(),e.close(),e.signalOnPlayAudio=void 0,e.signalOnPauseAudio=void 0,e.signalOnPlayVideo=void 0,e.signalOnPauseVideo=void 0};e.channel.oniceconnectionstatechange=function(e){switch(e){case"completed":case"connected":i();break;case"checking":case"closed":break;case"failed":d();break;default:a.Logger.warning("unknown ice connection state:",e)}},e.channel.createOffer(!0)},e=>t(s,e))},f.prototype.unsubscribe=function(e,n,a){var r=this;e instanceof i.RemoteStream?r.streamIdToSubscriptionId.has(e.id())?(e.close(),e.signalOnPlayAudio=void 0,e.signalOnPauseAudio=void 0,e.signalOnPlayVideo=void 0,e.signalOnPauseVideo=void 0,e.channel&&"function"==typeof e.channel.close&&e.channel.close(),r.signaling.sendMessage("unsubscribe",{id:r.streamIdToSubscriptionId.get(e.id())}),r.subscriptionToStream.delete(r.streamIdToSubscriptionId.get(e.id())),r.streamIdToSubscriptionId.delete(e.id()),t(n)):t(a,"The specific stream is not subscribed."):t(a,"invalid stream")},f.prototype.onMessage=function(e){"function"==typeof e&&this.on("message-received",e)},i.ConferenceClient=function(){"use strict";var e=function(e){f.call(this,e),this.join=function(e,t,n){f.prototype.join.call(this,e,t,n)},this.leave=function(){this.signaling.disconnect(),this.externalUrlToSubscriptionId.clear(),this.state=0},this.send=function(e,n,i,a){const r=this;if(void 0===e||null===e||"function"==typeof e)return t(a,"nothing to send");if(void 0===n)n="all";else if("string"==typeof n);else{if("function"!=typeof n)return t(a,"invalid receiver");a=i,i=n,n="all"}r.signaling.sendMessage("text",{to:n,message:e}).then(()=>{t(i)},e=>{t(a,e)})},this.mix=function(e,t,n,i){return c("mix",this.signaling,e,t,n,i)},this.unmix=function(e,t,n,i){return c("unmix",this.signaling,e,t,n,i)},this.shareScreen=function(e,n,r){a.Logger.warning("shareScreen is deprecated, please create a LocalStream and publish it to specific conference.");var o=this;"function"==typeof e&&(r=n,n=e,e={}),e=e||{},i.LocalStream.create({video:{device:"screen",extensionId:e.extensionId,resolution:e.resolution?e.resolution:{width:screen.width,height:screen.height},frameRate:e.frameRate},audio:!1},function(i,a){if(i)return t(r,i);o.publish(a,{maxVideoBW:e.maxVideoBW,videoCodec:e.videoCodec},function(e){t(n,e)},function(e){t(r,e)})})},this.playAudio=function(e,t,n){if(e instanceof i.Stream&&e.hasAudio()&&"function"==typeof e.signalOnPlayAudio)return e.signalOnPlayAudio(t,n);"function"==typeof n&&n("unable to call playAudio")},this.pauseAudio=function(e,t,n){if(e instanceof i.Stream&&e.hasAudio()&&"function"==typeof e.signalOnPauseAudio)return e.signalOnPauseAudio(t,n);"function"==typeof n&&n("unable to call pauseAudio")},this.playVideo=function(e,t,n){if(e instanceof i.Stream&&e.hasVideo()&&"function"==typeof e.signalOnPlayVideo)return e.signalOnPlayVideo(t,n);"function"==typeof n&&n("unable to call playVideo")},this.pauseVideo=function(e,t,n){if(e instanceof i.Stream&&e.hasVideo()&&"function"==typeof e.signalOnPauseVideo)return e.signalOnPauseVideo(t,n);"function"==typeof n&&n("unable to call pauseVideo")},this.addExternalOutput=function(e,n,i,a){var r=this;if("function"==typeof n?(a=i,i=n,n={}):"object"==typeof n&&null!==n||(n={}),r.externalUrlToSubscriptionId[e])return void t(a,"Cannot add external output to the same URL more than once.");n.url=e,n.video&&n.video.resolution&&(n.resolution=n.video.resolution);let o=n.streamId||r.commonMixedStream.id();if(!o)return void t(a,"Stream ID is not specified.");let s={audio:{from:o},video:{from:o,format:{codec:"h264"}}};n.resolution&&(s.video.parameters=s.video.parameters||{},"string"==typeof n.resolution?s.video.parameters.resolution=p[n.resolution]:s.video.parameters.resolution=n.resolution),n.frameRate&&(s.video.parameters=s.video.parameters||{},s.video.parameters.framerate=n.frameRate),n.keyFrameInterval&&(s.video.parameters=s.video.parameters||{},s.video.parameters.keyFrameInterval=n.keyFrameInterval),n.bitrateMultiplier&&1!==n.bitrateMultiplier&&(s.video.parameters=s.video.parameters||{},s.video.parameters.bitrate="x"+n.bitrateMultiplier.toString()),r.signaling.sendMessage("subscribe",{type:"streaming",connection:{url:e},media:s}).then(t=>{r.externalUrlToSubscriptionId[e]=t.id,r.externalOutputCallbacks.set(t.id,{onSuccess:i,onFailure:a})},e=>{t(a,e)})},this.updateExternalOutput=function(e,n,i,a){var r=this;if("function"==typeof n?(a=i,i=n,n={}):"object"==typeof n&&null!==n||(n={}),"string"!=typeof e||!r.externalUrlToSubscriptionId[e])return void t(a,"Invalid URL.");let o=n.streamId||r.commonMixedStream.id();if(!o)return t(a,"Stream ID is not specified.");let s={audio:{from:o},video:{from:o}};n.resolution&&(s.video.parameters=s.video.parameters||{},"string"==typeof n.resolution?s.video.parameters.resolution=p[n.resolution]:s.video.parameters.resolution=n.resolution),r.signaling.sendMessage("subscription-control",{id:r.externalUrlToSubscriptionId[e],operation:"update",data:s}).then(()=>{t(i)},e=>{t(a,e)})},this.removeExternalOutput=function(e,n,i){var a=this;if("string"!=typeof e||!a.externalUrlToSubscriptionId[e])return void t(i,"Invalid URL.");const r=a.externalUrlToSubscriptionId[e];delete a.externalUrlToSubscriptionId[e],a.signaling.sendMessage("unsubscribe",{id:r}).then(()=>{t(n),a.externalUrlToSubscriptionId.delete(e)},e=>{t(i,e)})},this.startRecorder=function(e,n,i){var a=this;if("function"==typeof e?(i=n,n=e,e={}):"object"==typeof e&&null!==e||(e={}),e.recorderId&&(e.audioCodec||e.videoCodec))return void t(i,"Cannot set codec when updating existing recorder.");let r={};if(null!==e.audioStreamId&&null!==e.videoStreamId){if(e.audioStreamId||e.videoStreamId?"string"!=typeof e.audioStreamId||e.videoStreamId?"string"!=typeof e.videoStreamId||e.audioStreamId?"string"==typeof e.audioStreamId&&"string"==typeof e.videoStreamId&&(r.audio={from:e.audioStreamId},r.video={from:e.videoStreamId}):(e.recorderId||(r.audio=!1),r.video={from:e.videoStreamId}):(r.audio={from:e.audioStreamId},e.recorderId||(r.video=!1)):(r.audio={from:a.commonMixedStream.id()},r.video={from:a.commonMixedStream.id()}),e.audioCodec&&r.audio){if(r.audio.format={codec:e.audioCodec},!a.remoteStreams[r.audio.from])return void t(i,"Invalid audio stream ID.");let n=a.remoteStreams[r.audio.from];if(!n.mediaInfo().audio)return void t(i,"Target stream does not have audio.");let o=[];n.mediaInfo().audio.format&&o.push(n.mediaInfo().audio.format),n.mediaInfo().audio.transcoding&&(o=o.concat(n.mediaInfo().audio.transcoding.format)),o.some(t=>(t.codec===e.audioCodec&&(r.audio.format.sampleRate=t.sampleRate,r.audio.format.channelNum=t.channelNum),t.codec===e.audioCodec))}e.videoCodec&&r.video&&(r.video.format={codec:e.videoCodec}),e.recorderId?(r.audio&&r.audio.format&&delete r.audio.format,r.video&&r.video.format&&delete r.video.format,a.signaling.sendMessage("subscription-control",{id:e.recorderId,operation:"update",data:r}).then(()=>{t(n,e.recorderId)},e=>{t(i,e)})):a.signaling.sendMessage("subscribe",{type:"recording",connection:{container:void 0},media:r}).then(e=>{a.recorderCallbacks[e.id]={onSuccess:n,onFailure:i}},e=>{t(i,e)})}else t(i,"Invalid audio and video stream ID.")},this.stopRecorder=function(e,n,i){var a=this;"function"==typeof e?(i=n,n=e,e={}):"object"==typeof e&&null!==e||(e={}),"string"!=typeof e.recorderId&&t("Invalid recorder ID."),a.signaling.sendMessage("unsubscribe",{id:e.recorderId}).then(()=>{t(n)},e=>{t(i,e)})},this.getRegion=function(e,n,a){var r=this;if("object"!=typeof e||null===e||"string"!=typeof e.id||""===e.id||null===e.mixedStreamId)return t(a,"Invalid options.");if(!e.mixedStreamId&&r.commonMixedStream&&(e.mixedStreamId=r.commonMixedStream.id()),"string"!=typeof e.mixedStreamId||!(r.remoteStreams[e.mixedStreamId]instanceof i.RemoteMixedStream))return t(a,"Invalid mixed stream ID.");var o={id:e.id,operation:"get-region",data:r.remoteStreams[e.mixedStreamId].viewport()};r.signaling.sendMessage("stream-control",o).then(e=>{t(n,{region:e.region})},e=>{t(a,e)})},this.setRegion=function(e,n,a){var r=this;if("object"!=typeof e||null===e||"string"!=typeof e.id||""===e.id||"string"!=typeof e.region||""===e.region||null===e.mixedStreamId)return t(a,"Invalid options.");if(!e.mixedStreamId&&r.commonMixedStream&&(e.mixedStreamId=r.commonMixedStream.id()),"string"!=typeof e.mixedStreamId||!(r.remoteStreams[e.mixedStreamId]instanceof i.RemoteMixedStream))return t(a,"Invalid mixed stream ID.");var o={id:e.id,operation:"set-region",data:{region:e.region,view:r.remoteStreams[e.mixedStreamId].viewport()}};r.signaling.sendMessage("stream-control",o).then(()=>{t(n)},e=>{t(a,e)})},this.getConnectionStats=function(e,n,i){e&&e.channel&&"function"==typeof e.channel.getConnectionStats?e.channel.getConnectionStats(function(e){t(n,e)},function(e){t(i,e)}):t(i,"invalid stream.")},this.mute=function(e,t,n,i){d("pause",this.signaling,e,t,n,i)},this.unmute=function(e,t,n,i){d("play",this.signaling,e,t,n,i)}};return e.prototype=Object.create(f.prototype),e.prototype.constructor=e,e.create=function(t){return new e(t)},e}(),i.SipClient=function(){var e=function(e){f.call(this,e),this.sip=!0,this.join=function(e,t,n){e.host=this.spec.host,e.secure=this.spec.secure,e=a.Base64.encodeBase64(JSON.stringify(e)),f.prototype.join.call(this,e,t,n)},this.subscribe=function(e,t,n,a){var r=this;"function"==typeof t?(a=n,n=t,t={}):"object"==typeof t&&null!==t||(t={});f.prototype.subscribe.call(this,e,t,function(e){r.dispatchEvent(new i.StreamEvent({type:"stream-subscribed",stream:e})),n(e)},a)},this.acceptCall=function(e,n){s(this.socket,"customMessage",{type:"acceptCall"},function(i,a){if(i)return t(n,i);t(e,a)})},this.rejectCall=function(e,n){s(this.socket,"customMessage",{type:"rejectCall"},function(i,a){if(i)return t(n,i);t(e,a)})},this.hangupCall=function(e,n){s(this.socket,"customMessage",{type:"hangupCall"},function(i,a){if(i)return t(n,i);t(e,a)})},this.makeCall=function(e,n,i){var a={type:"makeCall",payload:e};s(this.socket,"customMessage",a,function(e,a){if(e)return t(i,e);t(n,a)})}};return e.prototype=Object.create(f.prototype),e.prototype.constructor=e,e.create=function(t){return new e(t)},e}()}(),r.ChromeStableStack=function(e){"use strict";var t={},n=RTCPeerConnection;t.pc_config={iceServers:[]},t.con={optional:[{DtlsSrtpKeyAgreement:!0}]},e.iceServers instanceof Array&&(t.pc_config.iceServers=e.iceServers),void 0===e.audio&&(e.audio=!0),void 0===e.video&&(e.video=!0),t.mediaConstraints={mandatory:{OfferToReceiveVideo:e.video,OfferToReceiveAudio:e.audio}};var r=function(e){console.log("Error in Stack ",e)};t.peerConnection=new n(t.pc_config,t.con);var o=function(t){var n,i;return e.video&&e.maxVideoBW&&(null==(n=(t=t.replace(/b=AS:.*\r\n/g,"")).match(/m=video.*\r\n/))&&(n=t.match(/m=video.*\n/)),n&&n.length>0&&(i=n[0]+"b=AS:"+e.maxVideoBW+"\r\n",t=t.replace(n[0],i))),e.audio&&e.maxAudioBW&&(null==(n=t.match(/m=audio.*\r\n/))&&(n=t.match(/m=audio.*\n/)),n&&n.length>0&&(i=n[0]+"b=AS:"+e.maxAudioBW+"\r\n",t=t.replace(n[0],i))),t},s=function(t){return e.audioCodec?i.Common.setPreferredCodec(t,"audio",e.audioCodec):t},c=function(t){return e.videoCodec?i.Common.setPreferredCodec(t,"video",e.videoCodec):t},d=function(e){var t=s(e);return t=c(t)};t.close=function(){t.state="closed","closed"!==t.peerConnection.signalingState&&t.peerConnection.close()},e.localCandidates=[],t.peerConnection.onicecandidate=function(t){if(t.candidate){var n={sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid,candidate:t.candidate.candidate};n.candidate.match(/a=/)||(n.candidate="a="+n.candidate),e.remoteDescriptionSet?e.callback({type:"candidate",candidate:n}):(e.localCandidates.push(n),a.Logger.info("Storing candidate: ",e.localCandidates.length,n))}else console.log("End of candidates.")},t.peerConnection.onaddstream=function(e){t.onaddstream&&t.onaddstream(e)},t.peerConnection.onremovestream=function(e){t.onremovestream&&t.onremovestream(e)},t.peerConnection.oniceconnectionstatechange=function(e){t.oniceconnectionstatechange&&t.oniceconnectionstatechange(e.currentTarget.iceConnectionState)};var u,l,p=function(n){n.sdp=o(n.sdp),n.sdp=d(n.sdp.replace(/a=ice-options:google-ice\r\n/g,"")),e.callback({type:n.type,sdp:n.sdp}),u=n,t.peerConnection.setLocalDescription(n)},f=function(n){n.sdp=o(n.sdp),e.callback({type:n.type,sdp:n.sdp}),u=n,t.peerConnection.setLocalDescription(n)};return t.updateSpec=function(n,i){(n.maxVideoBW||n.maxAudioBW)&&(n.maxVideoBW&&(console.log("Maxvideo Requested",n.maxVideoBW),e.maxVideoBW=n.maxVideoBW),n.maxAudioBW&&(console.log("Maxaudio Requested",n.maxAudioBW),e.maxAudioBW=n.maxAudioBW),u.sdp=o(u.sdp),t.peerConnection.setLocalDescription(u,function(){l.sdp=o(l.sdp),t.peerConnection.setRemoteDescription(new RTCSessionDescription(l),function(){e.remoteDescriptionSet=!0,i&&i("success")})}))},t.createOffer=function(n){if(!0===n)"function"==typeof t.peerConnection.addTransceiver&&(e.audio&&t.peerConnection.addTransceiver("audio"),e.video&&t.peerConnection.addTransceiver("video")),t.peerConnection.createOffer(p,r,t.mediaConstraints);else{var i={offerToReceiveAudio:!1,offerToReceiveVideo:!1};t.peerConnection.createOffer(p,r,i)}},t.iceRestart=function(){var n={offerToReceiveAudio:e.audio,offerToReceiveVideo:e.video,iceRestart:!0};t.peerConnection.createOffer(p,r,n)},t.addStream=function(e){t.peerConnection.addStream(e)},e.remoteCandidates=[],e.remoteDescriptionSet=!1,t.processSignalingMessage=function(n){if("offer"===n.type)n.sdp=o(n.sdp),t.peerConnection.setRemoteDescription(new RTCSessionDescription(n),function(){t.peerConnection.createAnswer(f,function(e){a.Logger.error("Error: ",e)},t.mediaConstraints),e.remoteDescriptionSet=!0},function(e){a.Logger.error("Error setting Remote Description",e)});else if("answer"===n.type)console.log("Set remote and local description",n.sdp),n.sdp=o(n.sdp),l=n,t.peerConnection.setRemoteDescription(new RTCSessionDescription(n),function(){for(e.remoteDescriptionSet=!0,console.log("Candidates to be added: ",e.remoteCandidates.length,e.remoteCandidates);e.remoteCandidates.length>0;)t.peerConnection.addIceCandidate(e.remoteCandidates.shift());for(console.log("Local candidates to send:",e.localCandidates.length);e.localCandidates.length>0;)e.callback({type:"candidate",candidate:e.localCandidates.shift()})},function(e){console.error("Failed to set remote description, "+e)});else if("candidate"===n.type)try{var i;(i="object"==typeof n.candidate?n.candidate:JSON.parse(n.candidate)).candidate=i.candidate.replace(/a=/g,""),i.sdpMLineIndex=parseInt(i.sdpMLineIndex,10);var r=new RTCIceCandidate(i);e.remoteDescriptionSet?t.peerConnection.addIceCandidate(r):(e.remoteCandidates.push(r),console.log("Candidates stored: ",e.remoteCandidates.length,e.remoteCandidates))}catch(e){a.Logger.error("Error parsing candidate",n.candidate)}},t.getConnectionStats=function(e,n){t.peerConnection.getStats().then(t=>{e(i.Common.parseStats(t))}).catch(e=>{n(e)})},t},r.FirefoxStack=function(e){"use strict";var t={},n=mozRTCPeerConnection,r=mozRTCSessionDescription,o=mozRTCIceCandidate;t.pc_config={iceServers:[]},e.iceServers instanceof Array&&(t.pc_config.iceServers=e.iceServers),void 0===e.audio&&(e.audio=!0),void 0===e.video&&(e.video=!0),t.mediaConstraints={offerToReceiveAudio:e.audio,offerToReceiveVideo:e.video,mozDontOfferDataChannel:!0};var s=function(e){a.Logger.error("Error in Stack ",e)},c=!1;t.peerConnection=new n(t.pc_config),e.localCandidates=[],t.peerConnection.onicecandidate=function(t){t.candidate?(c=!0,t.candidate.candidate.match(/a=/)||(t.candidate.candidate="a="+t.candidate.candidate),e.remoteDescriptionSet?e.callback({type:"candidate",candidate:t.candidate}):(e.localCandidates.push(t.candidate),console.log("Local Candidates stored: ",e.localCandidates.length,e.localCandidates))):console.log("End of candidates.")};var d=function(t){return e.audioCodec?i.Common.setPreferredCodec(t,"audio",e.audioCodec):t},u=function(t){return e.videoCodec?i.Common.setPreferredCodec(t,"video",e.videoCodec):t},l=function(e){var t=d(e);return t=u(t)};t.peerConnection.onaddstream=function(e){t.onaddstream&&t.onaddstream(e)},t.peerConnection.onremovestream=function(e){t.onremovestream&&t.onremovestream(e)},t.peerConnection.oniceconnectionstatechange=function(e){t.oniceconnectionstatechange&&t.oniceconnectionstatechange(e.currentTarget.iceConnectionState)};var p,f=function(t){var n,i;return e.video&&e.maxVideoBW&&(null==(n=t.match(/m=video.*\r\n/))&&(n=t.match(/m=video.*\n/)),n&&n.length>0&&(i=n[0]+"b=AS:"+e.maxVideoBW+"\r\n",t=t.replace(n[0],i))),e.audio&&e.maxAudioBW&&(null==(n=t.match(/m=audio.*\r\n/))&&(n=t.match(/m=audio.*\n/)),n&&n.length>0&&(i=n[0]+"b=AS:"+e.maxAudioBW+"\r\n",t=t.replace(n[0],i))),t},m=function(t){t.sdp=f(t.sdp),t.sdp=l(t.sdp.replace(/a=ice-options:google-ice\r\n/g,"")),e.callback(t),p=t},g=function(n){n.sdp=f(n.sdp),n.sdp=n.sdp.replace(/a=ice-options:google-ice\r\n/g,""),e.callback(n),p=n,t.peerConnection.setLocalDescription(p)};return t.createOffer=function(e){!0===e?t.peerConnection.createOffer(m,s,t.mediaConstraints):t.peerConnection.createOffer(m,s)},t.addStream=function(e){t.peerConnection.addStream(e)},e.remoteCandidates=[],e.remoteDescriptionSet=!1,t.close=function(){t.state="closed","closed"!==t.peerConnection.signalingState&&t.peerConnection.close()},t.iceRestart=function(){var n={offerToReceiveAudio:e.audio,offerToReceiveVideo:e.video,iceRestart:!0};t.peerConnection.createOffer(m,s,n)},t.processSignalingMessage=function(n){if("offer"===n.type)n.sdp=f(n.sdp),t.peerConnection.setRemoteDescription(new r(n),function(){t.peerConnection.createAnswer(g,function(e){a.Logger.error("Error",e)},t.mediaConstraints),e.remoteDescriptionSet=!0},function(e){a.Logger.error("Error setting Remote Description",e)});else if("answer"===n.type)console.log("Set remote and local description",n.sdp),n.sdp=f(n.sdp),t.peerConnection.setLocalDescription(p,function(){t.peerConnection.setRemoteDescription(new r(n),function(){for(e.remoteDescriptionSet=!0,a.Logger.info("Remote Description successfully set");e.remoteCandidates.length>0&&c;)a.Logger.info("Setting stored remote candidates"),t.peerConnection.addIceCandidate(e.remoteCandidates.shift());for(;e.localCandidates.length>0;)a.Logger.info("Sending Candidate from list"),e.callback({type:"candidate",candidate:e.localCandidates.shift()})},function(e){a.Logger.error("Error Setting Remote Description",e)})},function(e){a.Logger.error("Failure setting Local Description",e)});else if("candidate"===n.type)try{var i;(i="object"==typeof n.candidate?n.candidate:JSON.parse(n.candidate)).candidate=i.candidate.replace(/ generation 0/g,""),i.candidate=i.candidate.replace(/ udp /g," UDP "),i.sdpMLineIndex=parseInt(i.sdpMLineIndex,10);var s=new o(i);if(e.remoteDescriptionSet&&c)for(t.peerConnection.addIceCandidate(s);e.remoteCandidates.length>0;)a.Logger.info("Setting stored remote candidates"),t.peerConnection.addIceCandidate(e.remoteCandidates.shift());else e.remoteCandidates.push(s)}catch(e){a.Logger.error("Error parsing candidate",n.candidate,e)}},t.getConnectionStats=function(e,n){t.peerConnection.getStats(null,function(t){e(i.Common.parseStats(t))},n)},t},r.EdgeORTCStack=function(t){"use strict";var n={};n.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},n.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},n.matchPrefix=function(e,t){return n.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},n.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1]}return n},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},n.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),a=0;a<i.length;a++)n[(t=i[a].trim().split("="))[0].trim()]=t[1];return n},n.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){i.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+" "+e.parameter+"\r\n"}),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},n.getDtlsParameters=function(e,t){var i=n.splitLines(e),a=(i=i.concat(n.splitLines(t))).filter(function(e){return 0===e.indexOf("a=fingerprint:")})[0].substr(14);return{role:"auto",fingerprints:[{algorithm:a.split(" ")[0],value:a.split(" ")[1]}]}},n.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},n.getIceParameters=function(e,t){var i=n.splitLines(e);return{usernameFragment:(i=i.concat(n.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:i.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=n.splitLines(e)[0].split(" "),a=3;a<i.length;a++){var r=i[a],o=n.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(o){var s=n.parseRtpMap(o),c=n.matchPrefix(e,"a=fmtp:"+r+" ");switch(s.parameters=c.length?n.parseFmtp(c[0]):{},s.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(n.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(n.parseExtmap(e))}),t},n.writeRtpDescription=function(e,t){var i="";return i+="m="+e+" ",i+=t.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){i+=n.writeRtpMap(e),i+=n.writeFmtp(e),i+=n.writeRtcpFb(e)}),i+="a=rtcp-mux\r\n"},n.parseRtpEncodingParameters=function(e){var t,i=[],a=n.parseRtpParameters(e),r=-1!==a.fecMechanisms.indexOf("RED"),o=-1!==a.fecMechanisms.indexOf("ULPFEC"),s=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=s.length>0&&s[0].ssrc,d=n.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),a.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{payloadType:e.payloadType,ssrc:t}};i.push(n),r&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:t,mechanism:o?"red+ulpfec":"red"},i.push(n))}}),0===i.length&&c&&i.push({ssrc:c});var u=n.matchPrefix(e,"b=");return u.length&&(0===u[0].indexOf("b=TIAS:")?u=parseInt(u[0].substr(7),10):0===u[0].indexOf("b=AS:")&&(u=parseInt(u[0].substr(5),10)),i.forEach(function(e){e.maxBitrate=u})),i},n.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,i,a){var r=n.writeRtpDescription(e.kind,t);if(r+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":"active"),r+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?r+="a=sendrecv\r\n":e.rtpSender?r+="a=sendonly\r\n":e.rtpReceiver?r+="a=recvonly\r\n":r+="a=inactive\r\n",e.rtpSender){var o="msid:"+a.id+" "+e.rtpSender.track.id+"\r\n";r+="a="+o,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n"},n.getDirection=function(e,t){for(var i=n.splitLines(e),a=0;a<i.length;a++)switch(i[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[a].substr(2)}return t?n.getDirection(t):"sendrecv"},e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}));var i={};i.pc_config={iceServers:[]},t.iceServers instanceof Array&&(i.pc_config.iceServers=t.iceServers),void 0===t.audio&&(t.audio=!0),void 0===t.video&&(t.video=!0),e.RTCPeerConnection=function(e){var t=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){t[e]=n[e].bind(n)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=e&&"max-bundle"===e.bundlePolicy,e&&e.iceServers){var i=JSON.parse(JSON.stringify(e.iceServers));this.iceOptions.iceServers=i.filter(function(e){if(e&&e.urls){var t=e.urls;return"string"==typeof t&&(t=[t]),!!(t=t.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")})[0])}return!1})}this.transceivers=[],this._localIceCandidatesBuffer=[]},e.RTCPeerConnection.prototype.addStream=function(e){this.localStreams.push(e.clone()),this._maybeFireNegotiationNeeded()},e.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},e.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},e.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},e.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var e=this,t=n.splitSections(e.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(n){if(!n.candidate||0===Object.keys(n.candidate).length)for(var i=1;i<t.length;i++)-1===t[i].indexOf("\r\na=end-of-candidates\r\n")&&(t[i]+="a=end-of-candidates\r\n");else-1===n.candidate.candidate.indexOf("typ endOfCandidates")&&(t[n.candidate.sdpMLineIndex+1]+="a="+n.candidate.candidate+"\r\n");e.localDescription.sdp=t.join(""),null!==e.dispatchEvent&&e.dispatchEvent(n),null!==e.onicecandidate&&e.onicecandidate(n),n.candidate||"complete"===e.iceGatheringState||e.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state})&&(e.iceGatheringState="complete")}),this._localIceCandidatesBuffer=[]},e.RTCPeerConnection.prototype._getCommonCapabilities=function(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach(function(e){for(var i=0;i<t.codecs.length;i++){var a=t.codecs[i];if(e.name.toLowerCase()===a.name.toLowerCase()&&e.clockRate===a.clockRate&&e.numChannels===a.numChannels){n.codecs.push(a);break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var a=t.headerExtensions[i];if(e.uri===a.uri){n.headerExtensions.push(a);break}}}),n},e.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(t,i){var a=this,r=new e.RTCIceGatherer(a.iceOptions),o=new e.RTCIceTransport(r);r.onlocalcandidate=function(e){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:i};var c=e.candidate,d=!c||0===Object.keys(c).length;d?(void 0===r.state&&(r.state="completed"),s.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(c.component="RTCP"===o.component?2:1,s.candidate.candidate=n.writeCandidate(c));var u=n.splitSections(a.localDescription.sdp);-1===s.candidate.candidate.indexOf("typ endOfCandidates")?u[s.candidate.sdpMLineIndex+1]+="a="+s.candidate.candidate+"\r\n":u[s.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n",a.localDescription.sdp=u.join("");var l=a.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});switch(a.iceGatheringState){case"new":a._localIceCandidatesBuffer.push(s),d&&l&&a._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":a._emitBufferedCandidates(),null!==a.dispatchEvent&&a.dispatchEvent(s),null!==a.onicecandidate&&a.onicecandidate(s),l&&(null!==a.dispatchEvent&&a.dispatchEvent(new Event("icecandidate")),null!==a.onicecandidate&&a.onicecandidate(new Event("icecandidate")),a.iceGatheringState="complete")}},o.onicestatechange=function(){a._updateConnectionState()};var s=new e.RTCDtlsTransport(o);return s.ondtlsstatechange=function(){a._updateConnectionState()},s.onerror=function(){a._updateConnectionState()},{iceGatherer:r,iceTransport:o,dtlsTransport:s}},e.RTCPeerConnection.prototype._transceive=function(e,t,i){var a=this._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(a.encodings=e.sendEncodingParameters,a.rtcp={cname:n.localCName},e.recvEncodingParameters.length&&(a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(a)),i&&e.rtpReceiver&&(a.encodings=e.recvEncodingParameters,a.rtcp={cname:e.cname},e.sendEncodingParameters.length&&(a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(a))},e.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");null!==this.dispatchEvent&&this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},e.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var e=new Event("negotiationneeded");null!==this.dispatchEvent&&this.dispatchEvent(e),null!==this.onnegotiationneeded&&this.onnegotiationneeded(e)},e.RTCPeerConnection.prototype._updateConnectionState=function(){var e,t=this,n={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(e){n[e.iceTransport.state]++,n[e.dtlsTransport.state]++}),n.connected+=n.completed,e="new",n.failed>0?e="failed":n.connecting>0||n.checking>0?e="connecting":n.disconnected>0?e="disconnected":n.new>0?e="new":(n.connected>0||n.completed>0)&&(e="connected"),e!==t.iceConnectionState){t.iceConnectionState=e;var i=new Event("iceconnectionstatechange");null!==this.dispatchEvent&&this.dispatchEvent(i),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(e)}},e.RTCPeerConnection.prototype.setLocalDescription=function(t){var i,a,r=this;if("offer"===t.type)this._pendingOffer&&(i=n.splitSections(t.sdp),a=i.shift(),i.forEach(function(e,t){var i=n.parseRtpParameters(e);r._pendingOffer[t].localCapabilities=i}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===t.type){i=n.splitSections(r.remoteDescription.sdp),a=i.shift();var o=n.matchPrefix(a,"a=ice-lite").length>0;i.forEach(function(e,t){var i=r.transceivers[t],s=i.iceGatherer,c=i.iceTransport,d=i.dtlsTransport,u=i.localCapabilities,l=i.remoteCapabilities;if(!("0"===e.split("\n",1)[0].split(" ",2)[1])){var p=n.getIceParameters(e,a);if(o){var f=n.matchPrefix(e,"a=candidate:").map(function(e){return n.parseCandidate(e)}).filter(function(e){return"1"===e.component});f.length&&c.setRemoteCandidates(f)}var m=n.getDtlsParameters(e,a);o&&(m.role="server"),m.role="client",r.usingBundle&&0!==t||(c.start(s,p,o?"controlling":"controlled"),d.start(m));var g=r._getCommonCapabilities(u,l);r._transceive(i,g.codecs.length>0,!1)}})}switch(this.localDescription={type:t.type,sdp:t.sdp},t.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+t.type+'"')}var s=arguments.length>1&&"function"==typeof arguments[1];if(s){var c=arguments[1];e.setTimeout(function(){c(),"new"===r.iceGatheringState&&(r.iceGatheringState="gathering"),r._emitBufferedCandidates()},0)}var d=e.Promise.resolve();return d.then(function(){s||("new"===r.iceGatheringState&&(r.iceGatheringState="gathering"),e.setTimeout(r._emitBufferedCandidates.bind(r),500))}),d},e.RTCPeerConnection.prototype.setRemoteDescription=function(t){var i=this,a=new e.MediaStream,r=[],o=n.splitSections(t.sdp),s=o.shift();n.matchPrefix(s,"a=ice-lite").length;switch(this.usingBundle=n.matchPrefix(s,"a=group:BUNDLE ").length>0,o.forEach(function(o,c){var d,u,l,p,f,m,g,h,v,S,C,b,E=n.splitLines(o)[0].substr(2).split(" "),y=E[0],T="0"===E[1],I=n.getDirection(o,s),_=n.parseRtpParameters(o);T||(C=n.getIceParameters(o,s),(b=n.getDtlsParameters(o,s)).role="client"),b.role="client",h=n.parseRtpEncodingParameters(o);var N=n.matchPrefix(o,"a=mid:");N=N.length?N[0].substr(6):n.generateIdentifier();var L,R=n.matchPrefix(o,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];R&&(L=R.value);var w=n.matchPrefix(o,"a=candidate:").map(function(e){return n.parseCandidate(e)}).filter(function(e){return"1"===e.component});if(w.push({}),"offer"!==t.type||T)"answer"!==t.type||T||(u=(d=i.transceivers[c]).iceGatherer,l=d.iceTransport,p=d.dtlsTransport,f=d.rtpSender,m=d.rtpReceiver,g=d.sendEncodingParameters,v=d.localCapabilities,i.transceivers[c].recvEncodingParameters=h,i.transceivers[c].remoteCapabilities=_,i.transceivers[c].cname=L,w.length&&l.setRemoteCandidates(w),i.usingBundle&&0!==c||(l.start(u,C,"controlling"),p.start(b)),i._transceive(d,"sendrecv"===I||"recvonly"===I,"sendrecv"===I||"sendonly"===I),!m||"sendrecv"!==I&&"sendonly"!==I?delete d.rtpReceiver:(S=m.track,r.push([S,m]),a.addTrack(S)));else{var P=i.usingBundle&&c>0?{iceGatherer:i.transceivers[0].iceGatherer,iceTransport:i.transceivers[0].iceTransport,dtlsTransport:i.transceivers[0].dtlsTransport}:i._createIceAndDtlsTransports(N,c);if(P.iceTransport.setRemoteCandidates(w),v=e.RTCRtpReceiver.getCapabilities(y),g=[{ssrc:1001*(2*c+2)}],m=new e.RTCRtpReceiver(P.dtlsTransport,y),S=m.track,r.push([S,m]),a.addTrack(S),i.localStreams.length>0&&i.localStreams[0].getTracks().length>=c){var D;"audio"===y?D=i.localStreams[0].getAudioTracks()[0]:"video"===y&&(D=i.localStreams[0].getVideoTracks()[0]),D&&(f=new e.RTCRtpSender(D,P.dtlsTransport))}i.transceivers[c]={iceGatherer:P.iceGatherer,iceTransport:P.iceTransport,dtlsTransport:P.dtlsTransport,localCapabilities:v,remoteCapabilities:_,rtpSender:f,rtpReceiver:m,kind:y,mid:N,cname:L,sendEncodingParameters:g,recvEncodingParameters:h},i._transceive(i.transceivers[c],!1,"sendrecv"===I||"sendonly"===I)}}),this.remoteDescription={type:t.type,sdp:t.sdp},t.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+t.type+'"')}return a.getTracks().length&&(i.remoteStreams.push(a),e.setTimeout(function(){var t=new Event("addstream");t.stream=a,null!==i.dispatchEvent&&i.dispatchEvent(t),null!==i.onaddstream&&e.setTimeout(function(){i.onaddstream(t)},0),r.forEach(function(n){var r=n[0],o=n[1],s=new Event("track");s.track=r,s.receiver=o,s.streams=[a],null!==i.dispatchEvent&&i.dispatchEvent(t),null!==i.ontrack&&e.setTimeout(function(){i.ontrack(s)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&e.setTimeout(arguments[1],0),e.Promise.resolve()},e.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},e.RTCPeerConnection.prototype.createOffer=function(){var t=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var i;1===arguments.length&&"function"!=typeof arguments[0]?i=arguments[0]:3===arguments.length&&(i=arguments[2]);var a=[],r=0,o=0;if(this.localStreams.length&&(r=this.localStreams[0].getAudioTracks().length,o=this.localStreams[0].getVideoTracks().length),i){if(i.mandatory||i.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==i.offerToReceiveAudio&&(r=i.offerToReceiveAudio),void 0!==i.offerToReceiveVideo&&(o=i.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(e){a.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?r>0:o>0}),"audio"===e.kind?r--:"video"===e.kind&&o--});r>0||o>0;)r>0&&(a.push({kind:"audio",wantReceive:!0}),r--),o>0&&(a.push({kind:"video",wantReceive:!0}),o--);var s=n.writeSessionBoilerplate(),c=[];a.forEach(function(i,a){var r,o,s=i.track,d=i.kind,u=n.generateIdentifier(),l=t.usingBundle&&a>0?{iceGatherer:c[0].iceGatherer,iceTransport:c[0].iceTransport,dtlsTransport:c[0].dtlsTransport}:t._createIceAndDtlsTransports(u,a),p=e.RTCRtpSender.getCapabilities(d),f=[{ssrc:1001*(2*a+1)}];s&&(r=new e.RTCRtpSender(s,l.dtlsTransport)),i.wantReceive&&(o=new e.RTCRtpReceiver(l.dtlsTransport,d)),c[a]={iceGatherer:l.iceGatherer,iceTransport:l.iceTransport,dtlsTransport:l.dtlsTransport,localCapabilities:p,remoteCapabilities:null,rtpSender:r,rtpReceiver:o,kind:d,mid:u,sendEncodingParameters:f,recvEncodingParameters:null}}),this.usingBundle&&(s+="a=group:BUNDLE "+c.map(function(e){return e.mid}).join(" ")+"\r\n"),a.forEach(function(e,i){var a=c[i];s+=n.writeMediaSection(a,a.localCapabilities,"offer",t.localStreams[0])}),this._pendingOffer=c;var d=new RTCSessionDescription({type:"offer",sdp:s});return arguments.length&&"function"==typeof arguments[0]&&e.setTimeout(arguments[0],0,d),e.Promise.resolve(d)},e.RTCPeerConnection.prototype.createAnswer=function(){var t=this,i=n.writeSessionBoilerplate();this.usingBundle&&(i+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(e){var a=t._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);i+=n.writeMediaSection(e,a,"answer",t.localStreams[0])});var a=new RTCSessionDescription({type:"answer",sdp:i});return arguments.length&&"function"==typeof arguments[0]&&e.setTimeout(arguments[0],0,a),e.Promise.resolve(a)},e.RTCPeerConnection.prototype.addIceCandidate=function(t){if(null===t)this.transceivers.forEach(function(e){e.iceTransport.addRemoteCandidate({})});else{var i=t.sdpMLineIndex;if(t.sdpMid)for(var a=0;a<this.transceivers.length;a++)if(this.transceivers[a].mid===t.sdpMid){i=a;break}var r=this.transceivers[i];if(r){var o=Object.keys(t.candidate).length>0?n.parseCandidate(t.candidate):{};if("tcp"===o.protocol&&0===o.port)return;if("1"!==o.component)return;"endOfCandidates"===o.type&&(o={}),r.iceTransport.addRemoteCandidate(o);var s=n.splitSections(this.remoteDescription.sdp);s[i+1]+=(o.type?t.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=s.join("")}}return arguments.length>1&&"function"==typeof arguments[1]&&e.setTimeout(arguments[1],0),e.Promise.resolve()},i.mediaConstraints={offerToReceiveVideo:t.video,offerToReceiveAudio:t.audio};var r,o=function(e){a.Logger.error("Error in Edge Stack ",e)},s=function(e){if("H264"!==t.videoCodec&&"h264"!==t.videoCodec)return e;try{var n=e.match(/m=video.*\r\n/g)[0],i=n.replace(/\s120/,"").replace("\r\n","")+" 120\r\n";return e.replace(n,i)}catch(t){return e}},c=function(e){return s(e)},d=function(e){var n,i;return t.video&&t.maxVideoBW&&(null==(n=e.match(/m=video.*\r\n/))&&(n=e.match(/m=video.*\n/)),n&&n.length>0&&(i=n[0]+"b=AS:"+t.maxVideoBW+"\r\n",e=e.replace(n[0],i))),t.audio&&t.maxAudioBW&&(null==(n=e.match(/m=audio.*\r\n/))&&(n=e.match(/m=audio.*\n/)),n&&n.length>0&&(i=n[0]+"b=AS:"+t.maxAudioBW+"\r\n",e=e.replace(n[0],i))),e},u=function(e){e.sdp=d(e.sdp),e.sdp=c(e.sdp.replace(/a=ice-options:google-ice\r\n/g,"")),t.callback(e),r=e},l=function(e){e.sdp=d(e.sdp),e.sdp=e.sdp.replace(/a=ice-options:google-ice\r\n/g,""),t.callback(e),r=e,i.peerConnection.setLocalDescription(r)};return i.peerConnection=new e.RTCPeerConnection(i.pc_config),t.localCandidates=[],t.remoteCandidates=[],t.remoteDescriptionSet=!1,i.peerConnection.onicecandidate=function(e){if(e.candidate){e.candidate.candidate.match(/a=/)||(e.candidate.candidate="a="+e.candidate.candidate);var n={sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid,candidate:e.candidate.candidate};t.remoteDescriptionSet?t.callback({type:"candidate",candidate:n}):t.localCandidates.push(n)}else t.localCandidates.push({candidate:{}}),console.log("End of candidates.")},i.peerConnection.onaddstream=function(e){i.onaddstream&&i.onaddstream(e)},i.peerConnection.onremovestream=function(e){i.onremovestream&&i.onremovestream(e)},i.peerConnection.oniceconnectionstatechange=function(e){i.oniceconnectionstatechange&&i.oniceconnectionstatechange(e)},i.createOffer=function(e){!0===e?i.peerConnection.createOffer(u,o,i.mediaConstraints):i.peerConnection.createOffer(u,o)},i.addStream=function(e){i.peerConnection.addStream(e)},i.processSignalingMessage=function(e){if(a.Logger.debug("Process Signaling Message",e.type),"offer"===e.type)e.sdp=d(e.sdp),console.log("Set offer description \n",e.sdp),i.peerConnection.setRemoteDescription(new RTCSessionDescription(e),function(){i.peerConnection.createAnswer(l,function(e){a.Logger.error("Error",e)},i.mediaConstraints),t.remoteDescriptionSet=!0},function(e){a.Logger.error("Error setting Remote Description",e)});else if("answer"===e.type)console.log("Set remote description",e.sdp),e.sdp=d(e.sdp),i.peerConnection.setLocalDescription(r,function(){i.peerConnection.setRemoteDescription(new RTCSessionDescription(e),function(){for(t.remoteDescriptionSet=!0,a.Logger.info("Remote Description successfully set");t.remoteCandidates.length>0;)i.peerConnection.addIceCandidate(t.remoteCandidates.shift());for(;t.localCandidates.length>0;)t.callback({type:"candidate",candidate:t.localCandidates.shift()})},function(e){a.Logger.error("Failure Setting Remote Description",e)})},function(e){a.Logger.error("Failure Setting Local Description",e)});else if("candidate"===e.type)try{var n;(n="object"==typeof e.candidate?e.candidate:JSON.parse(e.candidate)).candidate=n.candidate.replace(/a=/g,""),n.sdpMLineIndex=parseInt(n.sdpMLineIndex,10);var o=new RTCIceCandidate(n);if(t.remoteDescriptionSet)for(i.peerConnection.addIceCandidate(o);t.remoteCandidates.length>0;)a.Logger.info("Setting stored remote candidates"),i.peerConnection.addIceCandidate(t.remoteCandidates.shift());else t.remoteCandidates.push(o)}catch(t){a.Logger.error("Error parsing candidate",e.candidate,t)}},i.close=function(){i.state="closed","closed"!==i.peerConnection.signalingState&&i.peerConnection.close()},i.getConnectionStats=function(e,t){t("getConnectionStats is not supported on Edge.")},i.iceRestart=function(){a.Logger.error("ICE restart on Edge is not supported yet.")},i},(i=i||{}).Error={STREAM_LOCAL_ACCESS_DENIED:{code:1101,message:"Cannot access to camera or micphone."},P2P_CONN_SERVER_UNKNOWN:{code:2100,message:"Server unknown error."},P2P_CONN_SERVER_UNAVAILABLE:{code:2101,message:"Server is unavaliable."},P2P_CONN_SERVER_BUSY:{code:2102,message:"Server is too busy."},P2P_CONN_SERVER_NOT_SUPPORTED:{code:2103,message:"Method has not been supported by server"},P2P_CONN_CLIENT_UNKNOWN:{code:2110,message:"Client unknown error."},P2P_CONN_CLIENT_NOT_INITIALIZED:{code:2111,message:"Connection is not initialized."},P2P_CONN_AUTH_UNKNOWN:{code:2120,message:"Authentication unknown error."},P2P_CONN_AUTH_FAILED:{code:2121,message:"Wrong username or token."},P2P_MESSAGING_TARGET_UNREACHABLE:{code:2201,message:"Remote user cannot be reached."},P2P_CHATROOM_ATTENDEE_EXCEED:{code:2301,message:"Exceed room's limitation"},P2P_CHATROOM_PEER_NOT_FOUND:{code:2302,message:"Peer not found. Only one client in the room."},P2P_CLIENT_UNKNOWN:{code:2400,message:"Unknown errors."},P2P_CLIENT_UNSUPPORTED_METHOD:{code:2401,message:"This method is unsupported in current browser."},P2P_CLIENT_ILLEGAL_ARGUMENT:{code:2402,message:"Illegal argument."},P2P_CLIENT_INVALID_STATE:{code:2403,message:"Invalid peer state."},getErrorByCode:function(e){return{1101:i.Error.STREAM_LOCAL_ACCESS_DENIED,2100:i.Error.P2P_CONN_SERVER_UNKNOWN,2101:i.Error.P2P_CONN_SERVER_UNAVAILABLE,2102:i.Error.P2P_CONN_SERVER_BUSY,2103:i.Error.P2P_CONN_SERVER_NOT_SUPPORTED,2110:i.Error.P2P_CONN_CLIENT_UNKNOWN,2111:i.Error.P2P_CONN_CLIENT_NOT_INITIALIZED,2120:i.Error.P2P_CONN_AUTH_UNKNOWN,2121:i.Error.P2P_CONN_AUTH_FAILED,2201:i.Error.P2P_MESSAGING_TARGET_UNREACHABLE,2301:i.Error.P2P_CHATROOM_ATTENDEE_EXCEED,2302:i.Error.P2P_CHATROOM_PEER_NOT_FOUND,2400:i.Error.P2P_CLIENT_UNKNOWN,2401:i.Error.P2P_CLIENT_UNSUPPORTED_METHOD,2402:i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT,2403:i.Error.P2P_CLIENT_INVALID_STATE}[e]}},(i=i||{}).PeerClient=function(e){"use strict";var t,r,o=i.EventDispatcher({}),s={READY:1,MATCHED:2,OFFERED:3,PENDING:4,CONNECTING:5,CONNECTED:6,ERROR:9},c={READY:1,REQUESTED:2,ACCEPTED:3,NEGOTIATING:4},d={MESSAGE:"message",FILE:"file"},u={READY:1,CONNECTING:2,CONNECTED:3},l=u.READY,p=e,f=function(e){return"[object Array]"===Object.prototype.toString.call(e)},m=null,g={},h={},v=null,S=!1,C={},b={offerToReceiveAudio:!0,offerToReceiveVideo:!0},E=null,y=i.Common.sysInfo(),T=!navigator.mozGetUserMedia,I=!!navigator.mozGetUserMedia;e&&(E={iceServers:e.iceServers});var _=function(e,t){return e.localeCompare(t)},N=function(e){return e},L=function(e,t){e.negotiationState=t},R=function(e,t){e.state!==s.CONNECTED&&e.state!==s.CONNECTING||(e.sendDataChannel&&e.sendDataChannel.close(),e.receiveDataChannel&&e.receiveDataChannel.close(),e.connection&&"closed"!==e.connection.iceConnectionState&&e.connection.close(),e.state!==s.READY&&(e.state=s.READY,o.dispatchEvent(new i.ChatEvent({type:"chat-stopped",peerId:e.id,senderId:t}))),te(e.connection))},w=function(e,t){t.sdk&&t.sdk&&"JavaScript"===t.sdk.type&&t.runtime&&"FireFox"===t.runtime.name?(e.remoteSideSupportsRemoveStream=!1,e.remoteSideSupportsPlanB=!1,e.remoteSideSupportsUnifiedPlan=!0):(e.remoteSideSupportsRemoveStream=!0,e.remoteSideSupportsPlanB=!0,e.remoteSideSupportsUnifiedPlan=!1)},P=function(){S=!0,l=u.CONNECTED},D=function(){r&&r(),t=void 0,r=void 0},O=function(){S=!1,l=u.READY,o.dispatchEvent(new i.ClientEvent({type:"server-disconnected"}))},k=function(e,t){var n=g[e];n||(oe(e),n=g[e]),w(n,t),n.state===s.READY||n.state===s.PENDING?(g[e].state=s.PENDING,o.dispatchEvent(new i.ChatEvent({type:"chat-invited",senderId:e}))):n.state===s.OFFERED&&_(v,e)<0&&(n.state=s.PENDING,de(e,function(){o.dispatchEvent(new i.ChatEvent({type:"chat-accepted",senderId:e}))}))},A=function(e){var t=g[e];t&&t.connection&&(t.sendDataChannel&&t.sendDataChannel.close(),t.receiveDataChannel&&t.receiveDataChannel.close(),t.connection.close()),delete g[e],o.dispatchEvent(new i.ChatEvent({type:"chat-denied",senderId:e}))},x=function(e,t){a.Logger.debug("Received chat accepted.");var n=g[e];n&&(n.state=s.MATCHED,w(n,t),ee(n),n.state=s.CONNECTING,ie(n.id),o.dispatchEvent(new i.ChatEvent({type:"chat-accepted",senderId:e})))},M=function(e){var t=g[e];t&&t.connection&&R(t,e),delete g[e]},U=function(e,t){var n=g[t];n&&n.state===s.CONNECTING&&(n.connection||ee(n)),K(n,e)},V=function(e,t){h[e.streamId]=e.type,a.Logger.debug("remote stream ID:"+e.streamId+",type:"+h[e.streamId])},F=function(e){v=e,t&&t(e),t=void 0,r=void 0},B=function(){Ee()},G=function(e){a.Logger.debug("On negotiation needed."),e.isCaller&&"stable"===e.connection.signalingState&&e.negotiationState===c.READY?re(e):!e.isCaller&&m?m.sendNegotiationNeeded(e.id):e.isNegotiationNeeded=!0},W=function(e,t){t.candidate&&m&&m.sendSignalMessage(e.id,{type:"candidates",candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex})},j=function(e,t){if(e&&a.Logger.debug("On remote ice candidate from peer "+e.id),e&&(e.state===s.OFFERED||e.state===s.CONNECTING||e.state===s.CONNECTED)){var n=new RTCIceCandidate({candidate:t.message.candidate,sdpMid:t.message.sdpMid,sdpMLineIndex:t.message.sdpMLineIndex});e.connection?(a.Logger.debug("Add remote ice candidates."),e.connection.addIceCandidate(n,X,Q)):(a.Logger.debug("Cache remote ice candidates."),e.remoteIceCandidates||(e.remoteIceCandidates=[]),e.remoteIceCandidates.push(n))}},J=function(e,t){if(e)switch(e.state){case s.OFFERED:case s.MATCHED:e.state=s.CONNECTING,ee(e);case s.CONNECTING:case s.CONNECTED:a.Logger.debug("About to set remote description. Signaling state: "+e.connection.signalingState),t.message.sdp=Re(t.message.sdp);var n=new RTCSessionDescription(t.message);e.connection.setRemoteDescription(n).then(()=>{ge(e),le(e)},function(e){a.Logger.debug("Set remote description failed. Message: "+JSON.stringify(e))});break;default:a.Logger.debug("Unexpected peer state: "+e.state)}else a.Logger.debug('"peer" cannot be null or undefined')},H=function(e,t){if(e&&(e.state===s.CONNECTING||e.state===s.CONNECTED)){a.Logger.debug("About to set remote description. Signaling state: "+e.connection.signalingState),t.message.sdp=Re(t.message.sdp);var n=new RTCSessionDescription(t.message);e.connection.setRemoteDescription(new RTCSessionDescription(n)).then(()=>{a.Logger.debug("Set remote descripiton successfully."),le(e),fe(e)},function(e){a.Logger.debug("Set remote description failed. Message: "+e)})}},z=function(e,t){var n=h[e.id];if(n){var a={media:{}};"screen"===n?a.media.video={source:"screen-cast"}:(a.media.video=e.getVideoTracks().length>0&&{source:"camera"},a.media.audio=e.getAudioTracks().length>0);var r=new i.RemoteStream(a);return r.mediaStream=e,r.from=t.id,r.id=function(){return e.id},r}return null},Y=function(e,t){a.Logger.debug("Remote stream added.");var n=z(t.stream,e);if(n){var r=new i.StreamEvent({type:"stream-added",senderId:e.id,stream:n});o.dispatchEvent(r)}},q=function(e,t){a.Logger.debug("Remote stream removed.");var n=z(t.stream,e);if(n){var r=new i.StreamEvent({type:"stream-removed",stream:n});o.dispatchEvent(r)}},K=function(e,t){a.Logger.debug("S->C: "+JSON.stringify(t)),"offer"===t.type?J(e,{message:t}):"answer"===t.type?H(e,{message:t}):"candidates"===t.type&&j(e,{message:t})},Z=function(e,t){e&&(a.Logger.debug("Ice connection state changed. State: "+e.connection.iceConnectionState),"closed"!==e.connection.iceConnectionState&&"failed"!==e.connection.iceConnectionState||e.state!==s.CONNECTED||(R(e,e.id),m&&m.sendChatStopped(e.id),delete g[e.id]),"connected"!==e.connection.iceConnectionState&&"completed"!==e.connection.iceConnectionState||(e.lastDisconnect=new Date("2099/12/31").getTime(),e.state!==s.CONNECTED&&(e.state=s.CONNECTED,o.dispatchEvent(new i.ChatEvent({type:"chat-started",peerId:e.id})))),"checking"===e.connection.iceConnectionState&&(e.lastDisconnect=new Date("2099/12/31").getTime()),"disconnected"===e.connection.iceConnectionState&&(e.lastDisconnect=(new Date).getTime(),setTimeout(function(){(new Date).getTime()-e.lastDisconnect>=15e3&&(a.Logger.debug("Disconnect timeout."),R(e,e.id),e===g[e.id]&&delete g[e.id])},15e3)))},X=function(){a.Logger.debug("Add ice candidate success.")},Q=function(e){a.Logger.debug("Add ice candidate failed. Error: "+e)},$=function(e){a.Logger.debug("Signaling state changed: "+e.connection.signalingState),"closed"===e.connection.signalingState?(R(e,e.id),delete g[e.id]):"stable"===e.connection.signalingState&&(L(e,c.READY),e.isCaller&&e.isNegotiationNeeded&&m?re(e):pe(e))},ee=function(e){if(!e||e.connection)return!0;try{e.connection=new RTCPeerConnection(E),"function"==typeof e.connection.addTransceiver&&(e.connection.addTransceiver("audio"),e.connection.addTransceiver("video")),e.connection.onicecandidate=function(t){W(e,t)},e.connection.onaddstream=function(t){Y(e,t)},e.connection.onremovestream=function(t){q(e,t)},e.connection.oniceconnectionstatechange=function(t){Z(e)},e.connection.onnegotiationneeded=function(){G(g[e.id])},e.connection.onsignalingstatechange=function(){$(e)},e.connection.ondatachannel=function(t){a.Logger.debug(v+": On data channel"),e.dataChannels[t.channel.label]||(e.dataChannels[t.channel.label]=t.channel,a.Logger.debug("Save remote created data channel.")),ne(t.channel,e)}}catch(e){return a.Logger.debug("Failed to create PeerConnection, exception: "+e.message),!1}return!0},te=function(e){e.onicecandidate=void 0,e.onaddstream=void 0,e.onremovestream=void 0,e.oniceconnectionstatechange=void 0,e.onnegotiationneeded=void 0,e.onsignalingstatechange=void 0},ne=function(e,t){e.onmessage=function(e){Te(t,e)},e.onopen=function(e){Ie(t,e)},e.onclose=function(e){_e(t,e)},e.onerror=function(e){a.Logger.debug("Data Channel Error:",e)}},ie=function(e,t){t||(t=d.MESSAGE),ae(N(e),t)},ae=function(e,t){var n=g[e];if(n&&!n.dataChannels[t]){a.Logger.debug("Do create data channel.");try{var i=n.connection.createDataChannel(t,null);ne(i,n),n.dataChannels[d.MESSAGE]=i}catch(e){a.Logger.error("Failed to create SendDataChannel, exception: "+e.message)}}},re=function(e){a.Logger.debug("Do renegotiation."),L(e,c.NEGOTIATING),ue(e)},oe=function(e){return g[e]||(g[e]={state:s.READY,id:e,pendingStreams:[],pendingUnpublishStreams:[],remoteIceCandidates:[],dataChannels:{},pendingMessages:[],negotiationState:c.READY,lastDisconnect:new Date("2099/12/31").getTime(),publishedStreams:[],isCaller:!0,remoteSideSupportsRemoveStream:!1,remoteSideSupportsPlanB:!1,remoteSideSupportsUnifiedPlan:!1}),g[e]},se=function(e){var t=g[e];a.Logger.debug(v+": Remote side needs negotiation."),t&&(t.isCaller&&"stable"===t.connection.signalingState&&t.negotiationState===c.READY?re(t):(t.isNegotiationNeeded=!0,a.Logger.error("Should not receive negotiation needed request because user is callee.")))},ce=function(e,t,n){if(m)if(e!==v){g[e]||oe(e);var r=g[e];r.state===s.READY||r.state===s.OFFERED?(a.Logger.debug("Send invitation to "+e),r.state=s.OFFERED,m.sendChatInvitation(e,y,function(){r.isCaller=!0,t&&t()},function(e){r.state=s.READY,n&&n(i.Error.getErrorByCode(e))})):(a.Logger.debug("Invalid state. Will not send invitation."),n&&n(i.Error.P2P_CLIENT_INVALID_STATE))}else n&&n(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT);else n&&n(i.Error.P2P_CONN_CLIENT_NOT_INITIALIZED)},de=function(e,t,n){!m&&n&&n(i.Error.P2P_CONN_CLIENT_NOT_INITIALIZED),g[e]||oe(e);var r=g[e];r.state===s.PENDING?(r.state=s.MATCHED,m.sendChatAccepted(e,y,function(){r.isCaller=!1,t&&t()},function(e){r.state=s.PENDING,n&&n(i.Error.getErrorByCode(e))})):(a.Logger.debug("Invalid state. Will not send acceptance."),n&&n(i.Error.P2P_CLIENT_INVALID_STATE))},ue=function(e){e.connection?"stable"===e.connection.signalingState?(pe(e),e.isNegotiationNeeded=!1,e.connection.createOffer(b).then(t=>{t.sdp=we(t.sdp,e),e.connection.setLocalDescription(t).then(()=>{a.Logger.debug("Set local descripiton successfully."),L(e,c.READY),m&&m.sendSignalMessage(e.id,t)},function(e){a.Logger.debug("Set local description failed. Message: "+JSON.stringify(e))})},function(e){a.Logger.debug("Create offer failed. Error info: "+JSON.stringify(e))})):L(e,c.NEGOTIATING):a.Logger.error("Peer connection have not been created.")},le=function(e){if(e&&e.connection&&e.remoteIceCandidates&&0!==e.remoteIceCandidates.length){for(var t=0;t<e.remoteIceCandidates.length;t++)e.state!==s.CONNECTED&&e.state!==s.CONNECTING||e.connection.addIceCandidate(e.remoteIceCandidates[t],X,Q);e.remoteIceCandidates=[]}},pe=function(e){if(a.Logger.debug("Draining pending streams."),e.connection){a.Logger.debug("Peer connection is ready for draining pending streams.");for(var t=0;t<e.pendingStreams.length;t++){var n=e.pendingStreams[t];e.pendingStreams.shift(),n.mediaStream&&n.mediaStream.active&&(me(n,e),e.connection.addStream(n.mediaStream),a.Logger.debug("Added stream to peer connection."),be(n,e),a.Logger.debug("Sent stream type."))}e.pendingStreams=[];for(var i=0;i<e.pendingUnpublishStreams.length;i++)e.pendingUnpublishStreams[i].mediaStream&&(e.connection.removeStream(e.pendingUnpublishStreams[i].mediaStream),a.Logger.debug("Remove stream."));e.pendingUnpublishStreams=[]}},fe=function(e){a.Logger.debug("Draining pendding messages.");var t=e.dataChannels[d.MESSAGE];if(t&&"closed"!==t.readyState){for(var n=0;n<e.pendingMessages.length;n++)t.send(e.pendingMessages[n]);e.pendingMessages=[]}},me=function(e,t){var n=e.id();C[n]||(C[n]=[]),C[n].push(t.id)},ge=function(e){e.connection?(pe(e),e.isNegotiationNeeded=!1,e.connection.createAnswer().then(t=>{t.sdp=we(t.sdp,e),e.connection.setLocalDescription(t).then(()=>{a.Logger.debug("Set local description successfully."),m&&m.sendSignalMessage(e.id,t),a.Logger.debug("Sent answer.")},function(e){a.Logger.error("Error occurred while setting local description. Error message:"+e)})},function(e){a.Logger.error("Create answer failed. Message: "+e)})):a.Logger.error("Peer connection have not been created.")},he=function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},ve=function(e,t,n,a){e instanceof i.LocalStream&&e.mediaStream&&e.mediaStream.active&&t?Se(e,t,n,a):a&&a(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT)},Se=function(e,t,n,r){a.Logger.debug("Publish to: "+t);var o=N(t);if(o){g[o]||oe(o);var c=g[o],d=c.publishedStreams.length+c.pendingStreams.length>0,u=c.remoteSideSupportsUnifiedPlan&&I||c.remoteSideSupportsPlanB&&T;if(d&&!u)return a.Logger.warning("Cannot publish more than one streams if local and remote use different multiple media sources plan."),void(r&&r(i.Error.P2P_CLIENT_UNSUPPORTED_METHOD));switch(c.state){case s.OFFERED:case s.MATCHED:case s.CONNECTING:case s.CONNECTED:break;default:return a.Logger.warning("Cannot publish stream in this state: "+c.state),void(r&&r(i.Error.P2P_CLIENT_INVALID_STATE))}if(he(c.publishedStreams,e)>-1)r&&r("The stream has been published.");else{switch(c.publishedStreams.push(e),f(e)?c.pendingStreams=c.pendingStreams.concat(e):e&&c.pendingStreams.push(e),c.state){case s.CONNECTING:case s.CONNECTED:c.pendingStreams.length>0&&pe(c);break;default:return a.Logger.debug("Unexpected peer state: "+c.state),void(r&&r(i.Error.P2P_CLIENT_INVALID_STATE))}n&&n()}}else r&&r(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT)},Ce=function(e,t,n,r){if(a.Logger.debug("Unpublish stream."),!(e instanceof i.LocalStream))return a.Logger.warning("Invalid argument stream"),void(r&&r(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT));var o=N(t);if(o)if(!g[o]||he(g[o].publishedStreams,e)<0)r&&r(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT);else{var c=g[o];if(navigator.mozGetUserMedia||!c.remoteSideSupportsRemoveStream)return a.Logger.error("Unpublish is not supported on Firefox."),void(r&&r(i.Error.P2P_CLIENT_UNSUPPORTED_METHOD));var d=he(c.publishedStreams,e);c.publishedStreams.splice(d,1),c.pendingUnpublishStreams.push(e),c.state===s.CONNECTED&&pe(c),n&&n()}else r&&(a.Logger.warning("Invalid argument targetId"),r(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT))},be=function(e,t){if(null!==e){var n="audio";e.isScreen()?(n="screen",e.hide=function(){a.Logger.debug("Unpublish screen sharing."),Ce(e,t.id)}):e.hasVideo()&&(n="video"),m&&m.sendStreamType(t.id,{streamId:e.mediaStream.id,type:n})}},Ee=function(e,t,n){if(m){if(e){var r=g[e];if(!r)return void(n&&(a.Logger.warning("Invalid target ID for stopping chat."),n(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT)));m.sendChatStopped(r.id),R(r,v),delete g[e]}else{var o=!0;for(var s in g){o=!1;var c=g[s];m.sendChatStopped(c.id),R(c,v),delete g[c.id]}if(o)return void(n&&(a.Logger.warning("No active connections can be stopped."),n(i.Error.P2P_CLIENT_INVALID_STATE)))}t&&t()}else n&&n(i.Error.P2P_CONN_CLIENT_NOT_INITIALIZED)},ye=function(e,t,n,r){var o=g[t];if(o&&o.state===s.CONNECTED){var c=o.dataChannels[d.MESSAGE];c&&"open"===c.readyState?c.send(e):(o.pendingMessages.push(e),ie(t)),n&&n()}else r&&(a.Logger.error("Invalid peer state."),r(i.Error.P2P_CLIENT_INVALID_STATE))},Te=function(e,t){var n=new i.DataEvent({type:"data-received",senderId:e.id,data:t.data});o.dispatchEvent(n)},Ie=function(e,t){a.Logger.debug("Data Channel is opened"),t.target.label===d.MESSAGE&&(a.Logger.debug("Data channel for messages is opened."),fe(e))},_e=function(e){a.Logger.debug("Data Channel for "+e+" is closed.")},Ne=function(e){return p.bandWidth&&p.bandWidth.maxAudioBW?i.Common.setPreferredBitrate(e,"audio",p.bandWidth.maxAudioBW):e},Le=function(e){return p.bandWidth&&p.bandWidth.maxVideoBW?i.Common.setPreferredBitrate(e,"video",p.bandWidth.maxVideoBW):e},Re=function(e){return e=Ne(e),e=Le(e)},we=function(e,t){return e=Pe(e),e=De(e,t)},Pe=function(e){return p.audioCodec?i.Common.setPreferredCodec(e,"audio",p.audioCodec):e},De=function(e,t){var n;return n=t&&t.preferredVideoCodec?t.preferredVideoCodec:p.videoCodec?p.videoCodec:"h264",i.Common.setPreferredCodec(e,"video",n)};return o.connect=function(e,t,r){if(l!==u.READY)return a.Logger.warning("Another peer has already connected"),void(r&&r(i.Error.P2P_CLIENT_INVALID_STATE));l=u.CONNECTING,(m=new n(e)).onConnected=P,m.onDisconnected=O,m.onConnectFailed=D,m.onChatStopped=M,m.onChatAccepted=x,m.onChatDenied=A,m.onChatInvitation=k,m.onChatSignal=U,m.onStreamType=V,m.onNegotiationNeeded=se,m.onAuthenticated=F,m.onForceDisconnect=B,m.connect(e,t,r)},o.disconnect=function(e,t){S?(Ee(),m&&m.finalize(),m=null,e&&e()):t&&t(i.Error.P2P_CLIENT_INVALID_STATE)},o.invite=ce,o.inviteWithStream=function(e,t,n,i){ce(e,function(){ve(t,e)},i)},o.publish=ve,o.unpublish=Ce,o.deny=function(e,t,n){if(g[e]&&g[e].state===s.PENDING){if(!m&&n)return void n(i.Error.P2P_CONN_CLIENT_NOT_INITIALIZED);m.sendChatDenied(e,t,function(e){n&&n(i.Error.getErrorByCode(e))}),delete g[e]}else n&&n(i.Error.P2P_CLIENT_INVALID_STATE)},o.accept=de,o.acceptWithStream=function(e,t,n,i){de(e,function(){ve(t,e)},i)},o.stop=Ee,o.send=function(e,t,n,r){return e?e.length>65535?(a.Logger.warning("Message too long. Max size: 65535."),void(r&&r(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT))):void ye(e,N(t),n,r):(a.Logger.warning("Message cannot be undefined, null or empty."),void(r&&r(i.Error.P2P_CLIENT_ILLEGAL_ARGUMENT)))},o.getConnectionStats=function(e,t,n){var a=N(e),r=g[a];r&&r.connection&&r.state===s.CONNECTED?t&&r.connection.getStats(null,function(e){t(i.Common.parseStats(e))},function(e){n&&n(e)}):n&&n("failed to get peerconnection statistics")},o.getAudioLevels=function(e,t,n){var r=N(e),o=g[r];if(o&&o.connection&&o.state===s.CONNECTED||n("Invalid peer connection status."),navigator.mozGetUserMedia)return a.Logger.error("GetAudioLevels is not supported on Firefox."),void(n&&n(i.Error.P2P_CLIENT_UNSUPPORTED_METHOD));t&&o.connection.getStats(function(e){t(i.Common.parseAudioLevel(e))},function(e){n&&n(e)})},o},e.Erizo=r,e.Woogeen=i,e.L=a}(window);